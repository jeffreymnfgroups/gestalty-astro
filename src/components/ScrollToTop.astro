---
---

<button
  id="scroll-to-top"
  class="scroll-to-top-btn"
  aria-label="Scroll to top"
  style="display: none;"
>
  <svg
    class="scroll-to-top-icon"
    width="24"
    height="24"
    viewBox="0 0 24 24"
    fill="none"
    xmlns="http://www.w3.org/2000/svg"
  >
    <path
      d="M12 19V5M12 5L5 12M12 5L19 12"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
  </svg>
  <svg
    class="scroll-to-top-progress"
    width="56"
    height="56"
    viewBox="0 0 56 56"
    fill="none"
    xmlns="http://www.w3.org/2000/svg"
  >
    <circle
      cx="28"
      cy="28"
      r="26"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-dasharray="163.36"
      stroke-dashoffset="163.36"
      opacity="0.2"
      class="scroll-to-top-progress-bg"
    />
    <circle
      cx="28"
      cy="28"
      r="26"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-dasharray="163.36"
      stroke-dashoffset="163.36"
      class="scroll-to-top-progress-circle"
    />
  </svg>
</button>

<style>
  .scroll-to-top-btn {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    z-index: 1000;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background-color: #fbc10d;
    color: #ffffff;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    overflow: visible;
  }

  .scroll-to-top-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .scroll-to-top-btn:active {
    transform: translateY(0);
  }

  .scroll-to-top-icon {
    position: relative;
    z-index: 2;
    transition: transform 0.2s ease;
    color: #ffffff;
  }

  .scroll-to-top-btn:hover .scroll-to-top-icon {
    transform: translateY(-1px);
  }

  .scroll-to-top-progress {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1;
    color: #ffffff;
    transform: rotate(-90deg);
  }

  .scroll-to-top-progress-bg {
    opacity: 0.3;
    stroke: #ffffff;
  }

  .scroll-to-top-progress-circle {
    stroke: #ffffff;
    transition: stroke-dashoffset 0.05s cubic-bezier(0.4, 0, 0.2, 1);
    will-change: stroke-dashoffset;
  }

  @media (max-width: 768px) {
    .scroll-to-top-btn {
      bottom: 1.5rem;
      right: 1.5rem;
      width: 48px;
      height: 48px;
    }

    .scroll-to-top-progress {
      width: 48px;
      height: 48px;
    }
  }
</style>

<script>
  (function () {
    const button = document.getElementById("scroll-to-top");
    if (!button) return;

    let lenisInstance: any = null;
    let isScrolling = false;
    let scrollTimeout: number | null = null;
    let rafId: number | null = null;
    let lastProgress = 0;

    // Try to get Lenis instance - check multiple possible locations
    function getLenisInstance() {
      if (typeof window === "undefined") return null;
      
      // Check if Lenis is stored globally
      const win = window as any;
      if (win.lenis) return win.lenis;
      
      // Check if there's a Lenis instance in the document
      const lenisElements = document.querySelectorAll('[data-lenis]');
      if (lenisElements.length > 0) {
        // Try to access through React ref or other means
        // For now, we'll use window.scrollTo which Lenis intercepts
      }
      
      return null;
    }

    function scrollToTop() {
      if (isScrolling) return;
      isScrolling = true;

      // Try to get Lenis instance
      lenisInstance = getLenisInstance();

      if (lenisInstance && typeof lenisInstance.scrollTo === "function") {
        // Use Lenis smooth scroll
        lenisInstance.scrollTo(0, {
          duration: 1.2,
          easing: (t: number) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
          onComplete: () => {
            isScrolling = false;
          },
        });
      } else {
        // Use native smooth scroll (Lenis will intercept if available)
        window.scrollTo({
          top: 0,
          behavior: "smooth",
        });
        setTimeout(() => {
          isScrolling = false;
        }, 1200);
      }
    }

    function updateScrollProgress() {
      if (!button) return;

      // Get scroll position - works with both native and Lenis
      const scrollY = window.scrollY || window.pageYOffset || document.documentElement.scrollTop;
      
      // Calculate total scrollable height
      const documentHeight = document.documentElement.scrollHeight;
      const windowHeight = window.innerHeight;
      const scrollableHeight = documentHeight - windowHeight;
      
      // Calculate progress (0 at top, 1 at bottom)
      const progress = scrollableHeight > 0 ? Math.min(1, Math.max(0, scrollY / scrollableHeight)) : 0;
      
      // Only update if progress changed significantly (smooth updates)
      if (Math.abs(progress - lastProgress) < 0.001) {
        return;
      }
      lastProgress = progress;
      
      // Update progress circle
      const progressCircle = button.querySelector('.scroll-to-top-progress-circle') as SVGElement;
      if (progressCircle) {
        const circumference = 163.36; // 2 * Ï€ * 26
        const offset = circumference * (1 - progress);
        progressCircle.style.strokeDashoffset = offset.toString();
      }
      
      // Show/hide button based on scroll position
      const showThreshold = 100;
      if (scrollY > showThreshold) {
        button.style.display = "flex";
        button.offsetHeight; // Force reflow
        button.style.opacity = "1";
      } else {
        button.style.opacity = "0";
        setTimeout(() => {
          if (!button) return;
          if (parseFloat(button.style.opacity || "1") === 0) {
            button.style.display = "none";
          }
        }, 300);
      }
    }

    function handleScroll() {
      if (!button) return;
      
      // Cancel any pending animation frame
      if (rafId !== null) {
        cancelAnimationFrame(rafId);
      }

      // Use requestAnimationFrame for smooth updates
      rafId = requestAnimationFrame(() => {
        updateScrollProgress();
        rafId = null;
      });
    }

    // Initialize
    if (button) {
      button.addEventListener("click", scrollToTop);
      
      // Listen to scroll events (works with both native and Lenis)
      window.addEventListener("scroll", handleScroll, { passive: true });
      document.addEventListener("scroll", handleScroll, { passive: true });
      
      // Also listen to Lenis scroll events if available
      document.addEventListener("lenis:scroll", handleScroll, { passive: true });

      // Initial check
      updateScrollProgress();

      // Handle Astro page transitions
      document.addEventListener("astro:page-load", () => {
        lenisInstance = null; // Reset Lenis instance
        lastProgress = 0; // Reset progress
        if (rafId !== null) {
          cancelAnimationFrame(rafId);
          rafId = null;
        }
        updateScrollProgress();
      });
    }
  })();
</script>
