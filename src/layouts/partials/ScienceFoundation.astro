---
import { markdownify } from "@/lib/utils/textConverter";
import type { CollectionEntry } from "astro:content";
import { getEntry } from "astro:content";
import LottieAnimation from "@/components/LottieAnimation";

const { title, subtitle, description, pillars } = (
  (await getEntry(
    "scienceFoundationSection",
    "science-foundation"
  )) as CollectionEntry<"scienceFoundationSection">
).data;

// Lottie animation paths for each pillar
const pillarLotties = [
  "/images/pillar1.lottie",
  "/images/pillar2.lottie",
  "/images/pillar3.lottie",
  "/images/pillar4.lottie"
];
---

<section class="sf-section relative isolate overflow-hidden bg-light text-body py-16 sm:py-20 lg:py-24">
  <div
    class="absolute inset-0 opacity-[0.05]"
    style={{
      backgroundImage: `url("data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80 80' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd' opacity='.35'%3E%3Cg fill='%2319254c' fill-opacity='1'%3E%3Cpath d='M54 40v-6h-3v6h-6v3h6v6h3v-6h6v-3h-6zm0-30V0h-3v10h-6v3h6v10h3V13h6v-3h-6zM13 40v-6H7v6H0v3h7v6h6v-6h6v-3h-6zM13 10V0H7v10H0v3h7v10h6V13h6v-3h-6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")`,
    }}
  />

  <div class="relative z-10 w-full px-4 sm:px-6 lg:px-8 xl:px-12">
    <div class="mx-auto max-w-[1400px]">
      <div class="sf-grid grid gap-8 xl:gap-10 items-center lg:grid-cols-[minmax(0,1fr)_minmax(0,1.1fr)]">
        <!-- Left Column: Text Content -->
        <div class="sf-copy mx-auto max-w-xl space-y-6 text-center lg:text-left">
          <div class="sf-eyebrow">
            <p class="text-xs font-semibold uppercase tracking-[0.4em] text-secondary/80">
              science-backed approach
            </p>
          </div>

          {title && (
            <h2 class="text-3xl sm:text-4xl lg:text-[2.9rem] font-bold leading-tight text-[#0d1b3d]" set:html={markdownify(title)} />
          )}

          {subtitle && (
            <p class="text-lg font-bold text-tertiary" set:html={markdownify(subtitle)} />
          )}

          {description && (
            <p class="text-base/[1.7] font-semibold text-[#0d1b3d]" set:html={markdownify(description)} />
          )}

          <!-- Pillar Buttons -->
          {pillars && pillars.length > 0 && (
            <div class="sf-buttons">
              {pillars.map((pillar, index) => (
                <button 
                  class={`sf-button ${index === 0 ? 'active' : ''}`}
                  data-pillar={index}
                  type="button"
                >
                  <span>Pillar {index + 1}</span>
                </button>
              ))}
            </div>
          )}

          <!-- Pillar Details Display -->
          {pillars && pillars.length > 0 && (
            <div class="sf-details">
              {pillars.map((pillar, index) => (
                <div 
                  class={`sf-detail-content ${index === 0 ? 'active' : ''}`}
                  data-pillar-detail={index}
                >
                  <h3 class="sf-detail-title">{pillar.title}</h3>
                  {pillar.tagline && (
                    <p class="sf-detail-tagline">{pillar.tagline}</p>
                  )}
                  {pillar.list && pillar.list.length > 0 && (
                    <ul class="sf-detail-list">
                      {pillar.list.map((item) => (
                        <li>{item}</li>
                      ))}
                    </ul>
                  )}
                </div>
              ))}
            </div>
          )}
        </div>

        <!-- Right Column: Small Lottie Animations -->
        <div class="sf-media w-full">
          {pillars && pillars.length > 0 && (
            <div class="sf-lottie-container">
              {pillars.map((pillar, index) => (
                <div 
                  class={`sf-lottie-wrapper ${index === 0 ? 'active' : ''}`}
                  data-pillar-lottie={index}
                >
                  <LottieAnimation 
                    src={pillarLotties[index]}
                    client:only="react"
                    className="w-full h-auto"
                  />
                  <div class="sf-lottie-label">
                    <span class="sf-pillar-number">Pillar {index + 1}</span>
                    <span class="sf-pillar-name">{pillar.title}</span>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  /* Buttons Container */
  .sf-buttons {
    display: flex;
    flex-direction: row;
    gap: 0.5rem;
    margin-top: 1.5rem;
    flex-wrap: wrap;
  }

  .sf-button {
    flex: 1;
    min-width: 120px;
    padding: 0.75rem 1.25rem;
    font-size: 0.875rem;
    font-weight: 600;
    color: #0d1b3d;
    background: rgba(255, 255, 255, 0.8);
    border: 1px solid rgba(25, 37, 76, 0.15);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
  }

  .sf-button:hover {
    background: rgba(255, 255, 255, 1);
    border-color: var(--color-secondary, #fcb23b);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(25, 37, 76, 0.1);
  }

  .sf-button.active {
    background: var(--color-secondary, #fcb23b);
    color: #0d1b3d;
    border-color: var(--color-secondary, #fcb23b);
    box-shadow: 0 4px 16px rgba(252, 178, 59, 0.3);
  }

  /* Details Display */
  .sf-details {
    position: relative;
    min-height: 200px;
    margin-top: 2rem;
    border-top: 1px solid rgba(25, 37, 76, 0.12);
    padding-top: 1.5rem;
  }

  .sf-detail-content {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    opacity: 0;
    visibility: hidden;
    transform: translateY(10px);
    transition: all 0.4s ease;
    padding: 1rem 0;
  }

  .sf-detail-content.active {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
    position: relative;
  }

  .sf-detail-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #0d1b3d;
    margin: 0 0 0.75rem 0;
    line-height: 1.3;
  }

  .sf-detail-tagline {
    font-size: 1rem;
    font-weight: 500;
    color: rgba(13, 27, 61, 0.8);
    margin: 0 0 1rem 0;
    line-height: 1.6;
  }

  .sf-detail-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .sf-detail-list li {
    font-size: 0.95rem;
    line-height: 1.7;
    color: #0d1b3d;
    padding-left: 1.5rem;
    position: relative;
  }

  .sf-detail-list li::before {
    content: "â†’";
    position: absolute;
    left: 0;
    color: var(--color-secondary, #fcb23b);
    font-weight: 700;
    font-size: 1rem;
    top: 0;
  }

  /* Media Column - Lottie Animations */
  .sf-media {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .sf-lottie-container {
    position: relative;
    width: 100%;
    max-width: 100%;
    margin: 0 auto;
    min-height: 400px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  }

  @media (min-width: 640px) {
    .sf-lottie-container {
      min-height: 550px;
    }
  }

  @media (min-width: 1024px) {
    .sf-lottie-container {
      min-height: 650px;
      padding: 0;
    }
  }

  @media (min-width: 1280px) {
    .sf-lottie-container {
      min-height: 750px;
    }
  }

  .sf-lottie-wrapper {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.5s ease, visibility 0.5s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  .sf-lottie-wrapper.active {
    opacity: 1;
    visibility: visible;
    position: relative;
  }


  .sf-lottie-label {
    margin-top: 1.25rem;
    text-align: center;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .sf-pillar-number {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: rgba(13, 27, 61, 0.6);
  }

  .sf-pillar-name {
    font-size: 1.125rem;
    font-weight: 700;
    color: #0d1b3d;
  }

  /* Mobile/Tablet Responsiveness */
  @media (max-width: 1023px) {
    .sf-buttons {
      flex-direction: column;
      gap: 0.5rem;
    }

    .sf-button {
      width: 100%;
    }

    .sf-lottie-stage {
      max-width: 100%;
    }


    .sf-detail-content {
      padding: 0.75rem 0;
    }

    .sf-detail-title {
      font-size: 1.25rem;
    }

    .sf-detail-tagline {
      font-size: 0.95rem;
    }

    .sf-detail-list li {
      font-size: 0.875rem;
    }
  }

  /* Smooth transitions */
  @media (prefers-reduced-motion: no-preference) {
    .sf-button,
    .sf-detail-content,
    .sf-lottie-wrapper {
      transition-duration: 0.3s;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .sf-button,
    .sf-detail-content,
    .sf-lottie-wrapper {
      transition: none;
    }
  }
</style>

<script>
  let eventListeners: Array<{ element: Element; event: string; handler: (e?: any) => void }> = [];
  let buttons: NodeListOf<Element> | null = null;
  let detailContents: NodeListOf<Element> | null = null;
  let lottieWrappers: NodeListOf<Element> | null = null;

  function cleanupScienceFoundation() {
    // Remove all event listeners
    eventListeners.forEach(({ element, event, handler }) => {
      element.removeEventListener(event, handler);
    });
    eventListeners = [];

    // Reset references
    buttons = null;
    detailContents = null;
    lottieWrappers = null;
  }

  function initScienceFoundation() {
    cleanupScienceFoundation();

    if (typeof window === 'undefined') return;

    buttons = document.querySelectorAll('.sf-button');
    detailContents = document.querySelectorAll('.sf-detail-content');
    lottieWrappers = document.querySelectorAll('.sf-lottie-wrapper');

    if (!buttons || buttons.length === 0) return;

    // Function to activate a specific pillar
    function activatePillar(index: number) {
      if (!buttons || !detailContents || !lottieWrappers) return;
      
      // Update buttons
      buttons.forEach((button, i) => {
        if (i === index) {
          button.classList.add('active');
          button.setAttribute('aria-selected', 'true');
        } else {
          button.classList.remove('active');
          button.setAttribute('aria-selected', 'false');
        }
      });

      // Update detail contents
      detailContents.forEach((detail, i) => {
        if (i === index) {
          detail.classList.add('active');
        } else {
          detail.classList.remove('active');
        }
      });

      // Update lottie wrappers
      lottieWrappers.forEach((wrapper, i) => {
        if (i === index) {
          wrapper.classList.add('active');
        } else {
          wrapper.classList.remove('active');
        }
      });
    }

    // Add click handlers to buttons
    buttons.forEach((button, index) => {
      button.setAttribute('tabindex', '0');
      button.setAttribute('role', 'button');
      button.setAttribute('aria-selected', index === 0 ? 'true' : 'false');

      const clickHandler = () => {
        activatePillar(index);
      };

      const keydownHandler = (e: Event) => {
        const keyEvent = e as KeyboardEvent;
        if (keyEvent.key === 'Enter' || keyEvent.key === ' ') {
          keyEvent.preventDefault();
          activatePillar(index);
        }
      };

      button.addEventListener('click', clickHandler);
      button.addEventListener('keydown', keydownHandler);
      
      eventListeners.push(
        { element: button, event: 'click', handler: clickHandler },
        { element: button, event: 'keydown', handler: keydownHandler }
      );
    });

    // Initialize first pillar as active
    activatePillar(0);
  }

  // Initialize on load
  if (typeof window !== 'undefined') {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(initScienceFoundation, 10);
      });
    } else {
      setTimeout(initScienceFoundation, 10);
    }

    // Re-initialize on page navigation
    document.addEventListener('astro:page-load', () => {
      setTimeout(initScienceFoundation, 50);
    });

    // Cleanup before page swap
    document.addEventListener('astro:before-swap', cleanupScienceFoundation);
  }
</script>
