---
import { markdownify } from "@/lib/utils/textConverter";
import type { CollectionEntry } from "astro:content";
import { getEntry } from "astro:content";
import LottieAnimation from "@/components/LottieAnimation";

const { title, subtitle, description, pillars } = (
  (await getEntry(
    "scienceFoundationSection",
    "science-foundation"
  )) as CollectionEntry<"scienceFoundationSection">
).data;

// Lottie animation paths for each pillar
const pillarLotties = [
  "/images/pillar1.lottie",
  "/images/pillar2.lottie",
  "/images/pillar3.lottie",
  "/images/pillar4.lottie"
];
---

<section class="sf-section relative isolate overflow-hidden bg-light text-body py-16 sm:py-20 lg:py-24 sf-section-animate">
  <!-- Soft gradient background -->
  <div
    class="pointer-events-none absolute inset-0 opacity-[0.9]"
    aria-hidden="true"
  >
    <div class="absolute -top-40 -left-24 h-72 w-72 rounded-full bg-[radial-gradient(circle_at_center,_rgba(63,99,233,0.18),_transparent_60%)]" />
    <div class="absolute -bottom-40 -right-10 h-80 w-80 rounded-full bg-[radial-gradient(circle_at_center,_rgba(252,178,59,0.22),_transparent_60%)]" />
  </div>

  <div class="relative z-10 w-full px-4 sm:px-6 lg:px-8 xl:px-12">
    <div class="mx-auto max-w-[1400px]">
      <div class="sf-shell rounded-3xl border border-white/60 bg-white/80 shadow-[0_18px_60px_rgba(15,23,42,0.12)] backdrop-blur-xl">
        <div class="sf-grid grid gap-10 lg:gap-14 items-center lg:grid-cols-[minmax(0,1.05fr)_minmax(0,1.1fr)] px-5 py-8 sm:px-8 sm:py-10 lg:px-10 lg:py-12">
          
          <!-- Left Column: Text Content -->
          <div class="sf-copy mx-auto max-w-xl space-y-6 text-center lg:text-left sf-copy-animate" data-aos="fade-up-sm">
            <div class="sf-eyebrow inline-flex items-center justify-center lg:justify-start gap-2 rounded-full border border-secondary/20 bg-secondary/5 px-3.5 py-1.5 text-[0.7rem] font-semibold uppercase tracking-[0.25em] text-secondary">
              <span class="inline-block h-1.5 w-1.5 rounded-full bg-secondary" />
              <span>Science-backed approach</span>
            </div>

            <div class="sf-heading-block space-y-3">
              {title && (
                <h2
                  class="text-3xl sm:text-4xl lg:text-[2.7rem] font-bold leading-tight text-[#0d1b3d]"
                  set:html={markdownify(title)}
                />
              )}

              {subtitle && (
                <p
                  class="text-base sm:text-lg font-semibold text-tertiary"
                  set:html={markdownify(subtitle)}
                />
              )}

              {description && (
                <p
                  class="text-sm sm:text-base/[1.7] font-medium text-slate-700"
                  set:html={markdownify(description)}
                />
              )}
            </div>

            {pillars && pillars.length > 0 && (
              <div class="sf-meta text-xs sm:text-sm text-slate-500 flex flex-wrap items-center justify-center lg:justify-start gap-2 pt-1">
                <span class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-2.5 py-1 font-medium text-slate-700">
                  <span class="h-1.5 w-1.5 rounded-full bg-emerald-500" />
                  {pillars.length} core pillars
                </span>
                <span class="hidden sm:inline-block h-[1px] w-6 bg-slate-200" />
                <span>Tap a pillar to see the underlying system in action.</span>
              </div>
            )}

            <!-- Pillar Buttons -->
            {pillars && pillars.length > 0 && (
              <div class="sf-buttons">
                {pillars.map((pillar, index) => (
                  <button
                    class={`sf-button ${index === 0 ? "active" : ""}`}
                    data-pillar={index}
                    type="button"
                  >
                    <span class="sf-button-pill-index">0{index + 1}</span>
                    <span class="sf-button-pill-label">{pillar.title}</span>
                  </button>
                ))}
              </div>
            )}

            <!-- Pillar Details Display -->
            {pillars && pillars.length > 0 && (
              <div class="sf-details">
                {pillars.map((pillar, index) => (
                  <div
                    class={`sf-detail-content ${index === 0 ? "active" : ""}`}
                    data-pillar-detail={index}
                  >
                    <h3 class="sf-detail-title">{pillar.title}</h3>

                    {pillar.tagline && (
                      <p class="sf-detail-tagline">{pillar.tagline}</p>
                    )}

                    {pillar.list && pillar.list.length > 0 && (
                      <ul class="sf-detail-list">
                        {pillar.list.map((item) => (
                          <li>{item}</li>
                        ))}
                      </ul>
                    )}
                  </div>
                ))}
              </div>
            )}
          </div>

          <!-- Right Column: Lottie Animations -->
          <div class="sf-media w-full flex items-center justify-center">
            {pillars && pillars.length > 0 && (
              <div class="sf-media-card sf-media-card-animate">
                <div class="sf-media-header">
                  <p>Each pillar tells a story.</p>
                </div>
                <div class="sf-lottie-container">
                  {pillars.map((pillar, index) => (
                    <div
                      class={`sf-lottie-wrapper ${index === 0 ? "active" : ""}`}
                      data-pillar-lottie={index}
                    >
                      <LottieAnimation
                        src={pillarLotties[index]}
                        client:only="react"
                        className="w-full h-auto"
                      />
                      <div class="sf-lottie-label">
                        <span class="sf-pillar-number">Pillar {index + 1}</span>
                        <span class="sf-pillar-name">{pillar.title}</span>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>

        </div>
      </div>
    </div>
  </div>
</section>

<style>
  /* Intro animations */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(26px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes fadeInUpSmall {
    from {
      opacity: 0;
      transform: translateY(16px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes fadeInUpLarge {
    from {
      opacity: 0;
      transform: translateY(32px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .sf-section-animate {
    animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
  }

  .sf-copy-animate > * {
    opacity: 0;
    animation: fadeInUpSmall 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
  }

  .sf-copy-animate > *:nth-child(1) { animation-delay: 0.1s; }
  .sf-copy-animate > *:nth-child(2) { animation-delay: 0.18s; }
  .sf-copy-animate > *:nth-child(3) { animation-delay: 0.26s; }
  .sf-copy-animate > *:nth-child(4) { animation-delay: 0.34s; }
  .sf-copy-animate > *:nth-child(5) { animation-delay: 0.42s; }
  .sf-copy-animate > *:nth-child(6) { animation-delay: 0.5s; }

  .sf-media-card-animate {
    opacity: 0;
    animation: fadeInUpLarge 0.7s cubic-bezier(0.4, 0, 0.2, 1) 0.15s forwards;
  }

  .sf-shell {
    transition: box-shadow 0.4s cubic-bezier(0.4, 0, 0.2, 1), transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), border-color 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .sf-shell:hover {
    transform: translateY(-3px);
    border-color: rgba(148, 163, 184, 0.9);
    box-shadow: 0 24px 80px rgba(15, 23, 42, 0.2);
  }

  /* Buttons Container */
  .sf-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 0.6rem;
    margin-top: 1.75rem;
  }

  .sf-button {
    position: relative;
    flex: 1 1 48%;
    min-width: 150px;
    padding: 0.7rem 0.95rem;
    border-radius: 999px;
    border: 1px solid rgba(30, 58, 138, 0.7);
    background: rgba(255, 255, 255, 0.9);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.55rem;
    text-align: left;
    overflow: hidden;
    isolation: isolate;
    transition:
      background 0.3s cubic-bezier(0.4, 0, 0.2, 1),
      border-color 0.3s cubic-bezier(0.4, 0, 0.2, 1),
      box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1),
      transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .sf-button::before {
    content: "";
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at top left, rgba(30, 58, 138, 0.09), transparent 55%);
    opacity: 0;
    transition: opacity 0.25s ease;
    z-index: -1;
  }

  .sf-button:hover {
    transform: translateY(-1px);
    background: #ffffff;
    border-color: rgba(30, 58, 138, 0.85);
    box-shadow: 0 10px 28px rgba(15, 23, 42, 0.12);
  }

  .sf-button:hover::before {
    opacity: 1;
  }

  .sf-button.active {
    background: linear-gradient(120deg, #fbc10d, #fcb23b);
    border-color: transparent;
    box-shadow: 0 14px 32px rgba(251, 193, 13, 0.4);
    color: #0b1022;
    transform: translateY(-1px);
  }

  .sf-button-pill-index {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 1.6rem;
    height: 1.6rem;
    border-radius: 999px;
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    background: rgba(15, 23, 42, 0.05);
    color: #0f172a;
  }

  .sf-button.active .sf-button-pill-index {
    background: rgba(15, 23, 42, 0.1);
    color: #111827;
  }

  .sf-button-pill-label {
    flex: 1;
    font-size: 0.8rem;
    font-weight: 600;
    color: #0f172a;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .sf-button.active .sf-button-pill-label {
    color: #0b1022;
  }

  /* Details Display */
  .sf-details {
    position: relative;
    min-height: 210px;
    margin-top: 1.9rem;
    border-top: 1px solid rgba(148, 163, 184, 0.3);
    padding-top: 1.2rem;
  }

  .sf-detail-content {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    opacity: 0;
    visibility: hidden;
    transform: translateY(12px);
    padding: 0.75rem 0 0.5rem;
    pointer-events: none;
    transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                transform 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                visibility 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .sf-detail-content.active {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
    position: relative;
    pointer-events: auto;
  }

  .sf-detail-title {
    font-size: 1.3rem;
    font-weight: 700;
    color: #0d1b3d;
    margin: 0 0 0.5rem 0;
    line-height: 1.3;
  }

  .sf-detail-tagline {
    font-size: 0.92rem;
    font-weight: 500;
    color: rgba(15, 23, 42, 0.76);
    margin: 0 0 0.9rem 0;
    line-height: 1.55;
  }

  .sf-detail-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
  }

  .sf-detail-list li {
    font-size: 0.9rem;
    line-height: 1.65;
    color: #0f172a;
    padding-left: 1.6rem;
    position: relative;
  }

  .sf-detail-list li::before {
    content: "â—";
    position: absolute;
    left: 0;
    top: 0.28rem;
    color: #fbc10d;
    font-size: 0.5rem;
  }

  /* Media Column - Card + Lottie */
  .sf-media-card {
    width: 100%;
    max-width: 540px;
    border-radius: 24px;
    border: 1px solid rgba(25, 37, 76, 0.2);
    background:
      radial-gradient(circle at top, rgba(25, 37, 76, 0.12), transparent 55%),
      #19254c;
    box-shadow: 0 20px 50px rgba(25, 37, 76, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.05);
    padding: 1.4rem 1.3rem 1.8rem;
    color: #f9fafb;
    transition: box-shadow 0.3s ease, transform 0.3s ease;
  }

  .sf-media-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 24px 60px rgba(25, 37, 76, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.08);
  }

  .sf-media-header {
    padding-bottom: 0.75rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .sf-media-header p {
    font-size: 0.75rem;
    font-weight: 500;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    color: rgba(249, 193, 13, 0.9);
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    margin: 0;
    padding: 0.5rem 0;
  }

  .sf-lottie-container {
    position: relative;
    width: 100%;
    min-height: 360px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem;
  }

  @media (min-width: 640px) {
    .sf-lottie-container {
      min-height: 460px;
      padding: 0.75rem;
    }
  }

  @media (min-width: 1024px) {
    .sf-lottie-container {
      min-height: 520px;
      padding: 1rem;
    }
  }

  .sf-lottie-wrapper {
    position: absolute;
    inset: 0;
    width: 100%;
    opacity: 0;
    visibility: hidden;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transform-origin: center;
    transform: scale(0.96) translateY(16px);
    pointer-events: none;
    transition: opacity 0.45s cubic-bezier(0.4, 0, 0.2, 1),
                transform 0.45s cubic-bezier(0.4, 0, 0.2, 1),
                visibility 0.45s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .sf-lottie-wrapper.active {
    opacity: 1;
    visibility: visible;
    position: relative;
    transform: scale(1) translateY(0);
    pointer-events: auto;
  }

  .sf-lottie-label {
    margin-top: 1.1rem;
    text-align: center;
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
  }

  .sf-pillar-number {
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: rgba(249, 193, 13, 0.8);
  }

  .sf-pillar-name {
    font-size: 1.05rem;
    font-weight: 700;
    color: #f9fafb;
  }

  /* Responsive tweaks */
  @media (max-width: 1023px) {
    .sf-buttons {
      flex-direction: column;
    }

    .sf-button {
      width: 100%;
    }

    .sf-detail-content {
      padding: 0.35rem 0;
    }

    .sf-detail-title {
      font-size: 1.15rem;
    }

    .sf-detail-tagline {
      font-size: 0.9rem;
    }

    .sf-detail-list li {
      font-size: 0.85rem;
    }

    .sf-media-card {
      max-width: 460px;
    }
  }

  /* Motion preference */
  @media (prefers-reduced-motion: reduce) {
    .sf-button,
    .sf-detail-content,
    .sf-lottie-wrapper,
    .sf-shell,
    .sf-section-animate,
    .sf-copy-animate > *,
    .sf-media-card-animate {
      animation: none !important;
      transition: none !important;
    }
    
    .sf-section-animate,
    .sf-copy-animate > *,
    .sf-media-card-animate {
      opacity: 1 !important;
      transform: none !important;
    }
  }
</style>

<script>
  interface EventListener {
    element: Element;
    event: string;
    handler: (e: Event) => void;
  }

  let eventListeners: EventListener[] = [];
  let buttons: NodeListOf<HTMLElement> | null = null;
  let detailContents: NodeListOf<HTMLElement> | null = null;
  let lottieWrappers: NodeListOf<HTMLElement> | null = null;

  function cleanupScienceFoundation() {
    eventListeners.forEach(({ element, event, handler }) => {
      element.removeEventListener(event, handler);
    });
    eventListeners = [];

    buttons = null;
    detailContents = null;
    lottieWrappers = null;
  }

  function activatePillar(index: number) {
    if (!buttons || !detailContents || !lottieWrappers) return;

    // Update button states
    buttons.forEach((button: HTMLElement, i: number) => {
      if (i === index) {
        button.classList.add("active");
        button.setAttribute("aria-selected", "true");
      } else {
        button.classList.remove("active");
        button.setAttribute("aria-selected", "false");
      }
    });

    // Update detail content - CSS transitions handle the animation
    detailContents.forEach((detail: HTMLElement, i: number) => {
      if (i === index) {
        detail.classList.add("active");
      } else {
        detail.classList.remove("active");
      }
    });

    // Update lottie wrappers - CSS transitions handle the animation
    lottieWrappers.forEach((wrapper: HTMLElement, i: number) => {
      if (i === index) {
        wrapper.classList.add("active");
      } else {
        wrapper.classList.remove("active");
      }
    });
  }

  function initScienceFoundation() {
    cleanupScienceFoundation();

    if (typeof window === "undefined") return;

    buttons = document.querySelectorAll(".sf-button");
    detailContents = document.querySelectorAll(".sf-detail-content");
    lottieWrappers = document.querySelectorAll(".sf-lottie-wrapper");

    if (!buttons || buttons.length === 0) return;

    buttons.forEach((button: HTMLElement, index: number) => {
      button.setAttribute("tabindex", "0");
      button.setAttribute("role", "tab");
      button.setAttribute("aria-selected", index === 0 ? "true" : "false");

      const clickHandler = () => activatePillar(index);

      const keydownHandler = (e: Event) => {
        const keyEvent = e as KeyboardEvent;
        if (keyEvent.key === "Enter" || keyEvent.key === " ") {
          keyEvent.preventDefault();
          activatePillar(index);
        }
      };

      button.addEventListener("click", clickHandler);
      button.addEventListener("keydown", keydownHandler);

      eventListeners.push(
        { element: button, event: "click", handler: clickHandler },
        { element: button, event: "keydown", handler: keydownHandler }
      );
    });

    // Initialize first pillar as active
    activatePillar(0);
  }

  if (typeof window !== "undefined") {
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", () => {
        setTimeout(initScienceFoundation, 30);
      });
    } else {
      setTimeout(initScienceFoundation, 30);
    }

    document.addEventListener("astro:page-load", () => {
      setTimeout(initScienceFoundation, 60);
    });

    document.addEventListener("astro:before-swap", cleanupScienceFoundation);
  }
</script>
