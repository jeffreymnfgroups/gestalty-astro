---
import ImageMod from "@/components/ImageMod.astro";
import FlipWords from "@/components/FlipWords.astro";
import ContainerTextFlip from "@/components/ContainerTextFlip.astro";
import DynamicIcon from "@/helpers/DynamicIcon";
import { markdownify } from "@/lib/utils/textConverter";
import type { CollectionEntry } from "astro:content";
import { getEntry } from "astro:content";

const { title, description, buttons, images } = (
  (await getEntry(
    "homeBannerSection",
    "home-banner"
  )) as CollectionEntry<"homeBannerSection">
).data;

const flipWords = ["Scientifically", "Strategically", "Psychologically", "Statistically"];

type ProcessedTitle = { beforeExam: string; afterExam: string; hasExam: boolean };
let processedTitle: ProcessedTitle = {
  beforeExam: title ?? "",
  afterExam: "",
  hasExam: false,
};
const examSegments = [
  { title: "NEET", subtitle: "Preparation" },
  { title: "UPSC", subtitle: "Coaching" },
  { title: "JEE", subtitle: "Excellence" },
];
const shuffleSequences = [
  [0, 1, 2],
  [2, 1, 0],
  [1, 0, 2],
];
---

{
  (
  <section id="hero-section" class="section pt-24">
      <div class="container relative z-10 w-full">
        <div class="row items-center gap-y-10 lg:gap-y-0">
          <div class="col-12 lg:col-7 max-w-3xl">
            <div class="mb-8 lg:mb-0">
              <div class="mb-5" data-aos="fade-up-sm">
                <div
                  data-shuffle
                  data-segments={JSON.stringify(examSegments)}
                  data-sequences={JSON.stringify(shuffleSequences)}
                  class="flex w-full items-center justify-center gap-5 lg:gap-7 text-text"
                >
                  {examSegments.map((segment, index) => (
                    <div class="flex items-center gap-5 lg:gap-7">
                      <div
                        class="flex flex-col min-w-[6rem] text-center transition-[transform,opacity] duration-300 ease-out"
                        data-shuffle-item
                      >
                        <span
                          class="text-base lg:text-lg font-semibold tracking-tight"
                          data-shuffle-title
                        >
                          {segment.title}
                        </span>
                        <span class="text-xs lg:text-sm text-text/70" data-shuffle-subtitle>
                          {segment.subtitle}
                        </span>
                      </div>
                      {index !== examSegments.length - 1 && (
                        <span class="hidden lg:block h-10 w-px bg-slate-200/80" aria-hidden="true"></span>
                      )}
                    </div>
                  ))}
                </div>
              </div>
              <div 
                class="mb-3 lg:mb-4 text-base lg:text-lg font-medium tracking-tight"
                data-aos="fade-up-sm"
              >
                <span>A System That Thinks with You </span>
                <FlipWords 
                  words={flipWords} 
                  duration={2500}
                  className="text-tertiary font-semibold inline-block ml-1"
                />
              </div>
              {title && (
                <h1
                  data-aos="fade-up-sm"
                  class="mb-4 lg:mb-5 text-h5 lg:text-h3 leading-[1.25] font-semibold"
                >
                  {processedTitle.hasExam ? (
                    <>
                      <span set:html={markdownify(processedTitle.beforeExam)} />
                      <ContainerTextFlip 
                        words={["JEE", "NEET", "UPSC"]}
                        interval={3000}
                        className="inline-block align-middle mx-1"
                      />
                      <span set:html={markdownify(processedTitle.afterExam)} />
                    </>
                  ) : (
                    <span set:html={markdownify(title)} />
                  )}
                </h1>
              )}
              {description && (
                <p
                  set:html={markdownify(description.split('<br><br>')[0])}
                  data-aos="fade-up-sm"
                  class="mb-4 text-base lg:text-[17px] leading-relaxed text-text/90"
                />
              )}
              {buttons && (
                <ul class="flex w-full flex-wrap items-center justify-center gap-8 lg:gap-10 mb-6">
                  {buttons.map(({ label, link }, index) => (
                    <li
                      class="first:ml-0"
                      data-aos="fade-up-sm"
                      data-aos-delay={100 + index * 50}>
                      <a
                        class="btn btn-outline-primary text-sm px-4 py-2 font-medium [&_.icon-wrapper]:h-8 [&_.icon-wrapper]:w-8 [&_.icon]:h-8 [&_.icon]:min-w-8 [&_svg]:h-4 [&_svg]:w-4"
                        href={link}
                        target={link.startsWith("http") ? "_blank" : "_self"}
                        rel="noopener">
                        {label}
                        <span class="sr-only">Details</span>
                        <span class="icon-wrapper">
                          <span class="icon">
                            <DynamicIcon icon={"FaArrowRight"} />
                          </span>
                          <span class="icon" aria-hidden="true">
                            <DynamicIcon icon={"FaArrowRight"} />
                          </span>
                        </span>
                      </a>
                    </li>
                  ))}
                </ul>
              )}
              {description && description.includes('<br><br>') && (
                <p
                  set:html={markdownify(description.split('<br><br>')[1])}
                  data-aos="fade-up-sm"
                  class="mb-3 text-base lg:text-[17px] leading-relaxed text-text/90 [&_em]:not-italic [&_i]:not-italic"
                />
              )}
              <p
                data-aos="fade-up-sm"
                class="text-base lg:text-[17px] leading-relaxed text-text/90"
                set:html={markdownify("Gestalty isn't just a learning toolâ€”it's a **cognitive scaffolding** system grounded in **proven educational science**")}
              >
              </p>
            </div>
          </div>
          <div class="col-12 lg:col-5 hidden lg:flex items-center justify-end lg:pl-8">
            <div class="w-full max-w-[720px] xl:max-w-[820px] aspect-[4/5] flex items-center justify-end lg:translate-x-4 xl:translate-x-8" data-aos="fade-left">
              <ImageMod 
                src="/images/banner-main1.png" 
                alt="Platform Dashboard" 
                class="w-full h-full object-contain object-right"
              />
            </div>
          </div>
        </div>
      </div>
    </section>
  )
}

<style>
  [data-shuffle-subtitle] {
    display: block;
    transition: opacity 0.45s ease, transform 0.45s ease, filter 0.45s ease;
    will-change: opacity, transform, filter;
  }
  [data-shuffle-subtitle].is-swapping {
    opacity: 0;
    transform: translateY(8px);
    filter: blur(6px);
  }
  [data-shuffle-subtitle].has-swapped {
    opacity: 1;
    transform: translateY(0);
    filter: blur(0);
  }
</style>

<script is:inline>
  (() => {
    let cleanup = () => {};

    const init = () => {
      const container = document.querySelector("[data-shuffle]");
      if (!container) return () => {};

      const itemsData = JSON.parse(container.getAttribute("data-segments") || "[]");
      const sequences = JSON.parse(container.getAttribute("data-sequences") || "[]");
      if (!Array.isArray(itemsData) || !Array.isArray(sequences) || !sequences.length) return () => {};

      const items = Array.from(container.querySelectorAll("[data-shuffle-item]"));
      if (items.length !== itemsData.length) return () => {};

      const subtitles = itemsData.map((item) => item.subtitle);

      let sequenceIndex = 0;
      let intervalId;

      const applySequence = (order) => {
        items.forEach((itemEl, idx) => {
          const subtitleEl = itemEl.querySelector("[data-shuffle-subtitle]");
          if (!subtitleEl) return;

          subtitleEl.classList.add("is-swapping");

          const swap = () => {
            subtitleEl.textContent = subtitles[order[idx]];
            subtitleEl.classList.remove("is-swapping");
            subtitleEl.classList.add("has-swapped");
            setTimeout(() => subtitleEl.classList.remove("has-swapped"), 320);
          };

          requestAnimationFrame(() => {
            setTimeout(swap, 90);
          });
        });
      };

      const cycle = () => {
        sequenceIndex = (sequenceIndex + 1) % sequences.length;
        applySequence(sequences[sequenceIndex]);
      };

      const start = () => {
        if (intervalId) clearInterval(intervalId);
        intervalId = window.setInterval(cycle, 2000);
      };

      applySequence(sequences[0]);
      start();

      const handleVisibility = () => {
        if (document.hidden) {
          clearInterval(intervalId);
        } else {
          start();
        }
      };

      document.addEventListener("visibilitychange", handleVisibility);

      return () => {
        clearInterval(intervalId);
        document.removeEventListener("visibilitychange", handleVisibility);
      };
    };

    const setup = () => {
      cleanup();
      cleanup = init();
    };

    const destroy = () => {
      cleanup();
    };

    const ready = () => {
      setup();
      document.addEventListener("astro:page-load", setup);
      document.addEventListener("astro:before-swap", destroy);
    };

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", ready, { once: true });
    } else {
      ready();
    }
  })();
</script>
