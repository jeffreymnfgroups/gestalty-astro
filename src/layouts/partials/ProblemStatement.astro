---
import { markdownify } from "@/lib/utils/textConverter";
import type { CollectionEntry } from "astro:content";
import { getEntry } from "astro:content";

const { title, subtitle, description, list, tagline, ctaText, ctaHref } = (
  (await getEntry(
    "problemStatementSection",
    "problem-statement"
  )) as CollectionEntry<"problemStatementSection">
).data;

const cards =
  list?.map((item, index) => ({
    name: item.title || "",
    description: item.description || "",
    src: `/images/problem${index + 1}.webp`,
  })) || [];

const slideCount = cards.length;
---

<section class="ps-section relative isolate overflow-hidden bg-light text-body py-16 sm:py-20 lg:py-24">
  <div
    class="absolute inset-0 opacity-[0.05]"
    style={{
      backgroundImage: `url("data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80 80' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd' opacity='.35'%3E%3Cg fill='%2319254c' fill-opacity='1'%3E%3Cpath d='M54 40v-6h-3v6h-6v3h6v6h3v-6h6v-3h-6zm0-30V0h-3v10h-6v3h6v10h3V13h6v-3h-6zM13 40v-6H7v6H0v3h7v6h6v-6h6v-3h-6zM13 10V0H7v10H0v3h7v10h6V13h6v-3h-6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")`,
    }}
  />

  <div class="relative z-10 w-full px-4 sm:px-6 lg:px-8 xl:px-12">
    <div class="mx-auto max-w-[1400px]">
      <div class="ps-grid grid gap-8 xl:gap-10 items-center lg:grid-cols-[minmax(0,1fr)_minmax(0,0.9fr)]">
        <!-- Left Copy Column -->
        <div class="ps-copy mx-auto max-w-xl space-y-6 text-center lg:text-left">
          {tagline && (
            <p class="text-xs font-semibold uppercase tracking-[0.4em] text-secondary/80">
              {tagline}
            </p>
          )}

          {title && (
            <h2 class="text-3xl sm:text-4xl lg:text-[2.9rem] font-bold leading-tight" set:html={markdownify(title)} />
          )}

          {subtitle && (
            <p class="text-lg font-bold text-tertiary" set:html={markdownify(subtitle)} />
          )}

          {slideCount > 0 && (
            <div class="ps-active-card space-y-3">
              <p class="ps-active-label text-[0.6rem] uppercase tracking-[0.4em] text-secondary/60 font-bold">
                Currently highlighting
              </p>
              <h4 class="ps-active-title text-2xl font-bold text-[#0d1b3d]" data-active-title>
                {cards[0]?.name || ""}
              </h4>
              <p class="ps-active-description text-base font-semibold text-[#0d1b3d]" data-active-description>
                {cards[0]?.description || ""}
              </p>
            </div>
          )}

          {description && (
            <p class="text-base/[1.7] font-semibold text-[#0d1b3d]" set:html={markdownify(description)} />
          )}

          {slideCount > 0 && (
            <p class="text-sm font-semibold uppercase tracking-[0.35em] text-secondary/70">
              {String(slideCount).padStart(2, "0")} invisible blockers uncovered
            </p>
          )}

          <div>
            <a
              href={ctaHref || "/how-it-works"}
              class="inline-flex items-center justify-center gap-2 rounded-full border border-transparent bg-secondary px-6 py-3 text-sm font-semibold uppercase tracking-wide text-body shadow-lg shadow-secondary/30 transition hover:-translate-y-0.5 hover:bg-tertiary hover:text-light"
            >
              {ctaText || "Learn More"}
              <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14m-7-7l7 7-7 7" />
              </svg>
            </a>
          </div>
        </div>

        <!-- Media Column -->
        <div class="ps-media w-full">
          <div class="ps-slider w-full">
            <div class="mb-4 flex items-center justify-between gap-4">
              <span class="text-sm font-bold uppercase tracking-[0.4em] text-secondary">Gallery</span>
              {slideCount > 0 && (
                <div class="ps-counter text-sm font-bold text-secondary">
                  <span data-slide-current>01</span>
                  <span class="mx-1 opacity-50">/</span>
                  <span data-slide-total>{String(slideCount).padStart(2, "0")}</span>
                </div>
              )}
            </div>

            <div class="ps-stage-wrapper relative">
              <button
                type="button"
                class="ps-nav ps-nav--prev"
                aria-label="Previous insight"
                data-ps-prev
                disabled={slideCount === 0}
                aria-disabled={slideCount === 0 ? "true" : "false"}
              >
                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
              </button>

              <div
                class="ps-stage"
                data-ps-slider
                role="region"
                aria-roledescription="carousel"
              >
                {slideCount === 0 && (
                  <div class="ps-empty flex h-full items-center justify-center text-sm text-body/70">
                    More insights coming soon
                  </div>
                )}

                {cards.map((card, index) => (
                  <figure
                    class={`ps-slide ${index === 0 ? "is-active" : ""}`}
                    data-index={index}
                    id={`ps-slide-${index}`}
                    aria-hidden={index === 0 ? "false" : "true"}
                    data-title={card.name || ""}
                    data-description={card.description || ""}
                  >
                    <img
                      src={card.src}
                      alt={card.name}
                      loading={index === 0 ? "eager" : "lazy"}
                    />
                  </figure>
                ))}
              </div>

              <button
                type="button"
                class="ps-nav ps-nav--next"
                aria-label="Next insight"
                data-ps-next
                disabled={slideCount === 0}
                aria-disabled={slideCount === 0 ? "true" : "false"}
              >
                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </button>

              <button
                type="button"
                class="ps-play"
                aria-label="Start autoplay"
                aria-pressed="false"
                disabled={slideCount === 0}
                aria-disabled={slideCount === 0 ? "true" : "false"}
                data-ps-play
              >
                <span class="sr-only">Toggle autoplay preview</span>
                <svg viewBox="0 0 32 32" class="ps-play-icon ps-play-icon--play h-5 w-5 fill-current" aria-hidden="true">
                  <path d="M12 9v14l10-7z" />
                </svg>
                <svg viewBox="0 0 32 32" class="ps-play-icon ps-play-icon--pause h-5 w-5 fill-current" aria-hidden="true">
                  <path d="M12 10h4v12h-4zM18 10h4v12h-4z" />
                </svg>
              </button>
            </div>

            {slideCount > 0 && (
              <div class="ps-pagination" role="tablist">
                {cards.map((card, index) => (
                  <button
                    type="button"
                    class={`ps-dot ${index === 0 ? "is-active" : ""}`}
                    aria-label={`Go to slide ${index + 1}`}
                    aria-controls={`ps-slide-${index}`}
                    aria-selected={index === 0 ? "true" : "false"}
                    role="tab"
                    data-ps-dot
                    data-index={index}
                  />
                ))}
              </div>
            )}
          </div>

          <div class="ps-thumbs-container">
            {slideCount > 0 && (
              <div class="ps-thumbs flex flex-row flex-wrap items-center justify-center gap-3 lg:flex-col lg:items-center lg:justify-center">
                {cards.map((card, index) => (
                  <button
                    type="button"
                    class={`ps-thumb ${index === 0 ? "is-active" : ""}`}
                    aria-label={`Show ${card.name || "slide"}`}
                    data-ps-thumb
                    data-index={index}
                  >
                    <span class="ps-thumb-ring" aria-hidden="true" />
                    <img src={card.src} alt={card.name || `Slide ${index + 1}`} loading="lazy" />
                  </button>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  .ps-active-card {
    border-top: 1px solid rgba(25, 37, 76, 0.12);
    padding-top: 1.5rem;
  }

  .ps-media {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.25rem;
  }

  .ps-slider {
    width: 100%;
    max-width: 480px;
    margin: 0 auto;
  }

  .ps-stage {
    aspect-ratio: 1 / 1;
    width: 100%;
    max-width: clamp(280px, 30vw, 420px);
    margin: 0 auto;
    border-radius: 24px;
    position: relative;
    overflow: hidden;
    background: linear-gradient(145deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.6));
    box-shadow: 0 20px 50px rgba(11, 11, 33, 0.12);
  }

  .ps-stage-wrapper {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .ps-slide {
    position: absolute;
    inset: 0;
    opacity: 0;
    transition: opacity 400ms ease, transform 400ms ease;
    pointer-events: none;
    padding: 1.25rem;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    gap: 1.5rem;
  }

  .ps-slide img {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .ps-slide::after {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(180deg, rgba(15, 19, 36, 0.05) 0%, rgba(15, 19, 36, 0.8) 100%);
    z-index: 1;
  }

  .ps-slide.is-active {
    opacity: 1;
    pointer-events: auto;
  }

  .ps-nav {
    height: 48px;
    width: 48px;
    border-radius: 999px;
    border: 1px solid rgba(9, 10, 28, 0.15);
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(8px);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: 4;
    color: #111224;
    box-shadow: 0 10px 25px rgba(6, 8, 20, 0.15);
    transition: transform 200ms ease, box-shadow 200ms ease;
  }

  .ps-nav:hover {
    transform: translateY(-50%) scale(1.05);
    box-shadow: 0 18px 35px rgba(6, 8, 20, 0.25);
  }

  .ps-nav--prev {
    left: -1.75rem;
  }

  .ps-nav--next {
    right: -1.75rem;
  }

  .ps-play {
    position: absolute;
    bottom: 1.4rem;
    right: 1.4rem;
    height: 64px;
    width: 64px;
    border-radius: 999px;
    border: none;
    background: #ffffff;
    color: var(--color-tertiary, #111224);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 20px 45px rgba(8, 9, 29, 0.2);
    z-index: 4;
    transition: transform 200ms ease;
    gap: 0.25rem;
  }

  .ps-play:hover {
    transform: scale(1.05);
  }

  .ps-play .ps-play-icon {
    display: none;
  }

  .ps-play .ps-play-icon--play {
    display: block;
  }

  .ps-play.is-playing {
    background: var(--color-secondary, #fcb23b);
    color: var(--color-body, #0d1b3d);
  }

  .ps-play.is-playing .ps-play-icon--play {
    display: none;
  }

  .ps-play.is-playing .ps-play-icon--pause {
    display: block;
  }

  .ps-pagination {
    margin-top: 1.25rem;
    display: flex;
    align-items: center;
    gap: 0.65rem;
    justify-content: center;
  }

  .ps-dot {
    width: 12px;
    height: 12px;
    border-radius: 999px;
    border: 1px solid rgba(25, 37, 76, 0.3);
    background: transparent;
    transition: background 200ms ease, transform 200ms ease, border-color 200ms ease;
  }

  .ps-dot.is-active {
    transform: scale(1.3);
    background: var(--color-secondary, #fcb23b);
    border-color: var(--color-secondary, #fcb23b);
  }

  .ps-thumbs-container {
    width: 100%;
    display: flex;
    justify-content: center;
    flex-shrink: 0;
  }

  .ps-thumbs {
    flex-wrap: wrap;
  }

  .ps-thumb {
    height: 64px;
    width: 64px;
    border-radius: 999px;
    border: none;
    background: transparent;
    position: relative;
    padding: 0;
    cursor: pointer;
    transition: transform 200ms ease;
  }

  .ps-thumb img {
    height: 100%;
    width: 100%;
    border-radius: 999px;
    object-fit: cover;
    border: 2px solid transparent;
  }

  .ps-thumb .ps-thumb-ring {
    position: absolute;
    inset: -6px;
    border-radius: 999px;
    border: 1px dashed rgba(25, 37, 76, 0.3);
  }

  .ps-thumb.is-active {
    transform: scale(1.08);
  }

  .ps-thumb.is-active img {
    border-color: var(--color-secondary, #fcb23b);
  }

  .ps-empty {
    font-weight: 500;
  }

  @media (max-width: 1023px) {
    .ps-stage {
      max-width: 100%;
    }

    .ps-nav--prev {
      left: 0.5rem;
    }

    .ps-nav--next {
      right: 0.5rem;
    }
  }

  @media (min-width: 1024px) {
    .ps-media {
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 1.5rem;
    }

    .ps-thumbs-container {
      width: auto;
      justify-content: center;
    }
  }

  @media (min-width: 1280px) {
    .ps-media {
      gap: 2rem;
    }
  }
</style>

<script>
// @ts-nocheck
const AUTOPLAY_DELAY = 4500;
let currentIndex = 0;
let autoplayId: number | null = null;
let isAutoplaying = false;
let eventListeners: Array<{ element: Element | Document | Window; event: string; handler: (e?: any) => void }> = [];
let sliderRoot: HTMLElement | null = null;
let slides: HTMLElement[] = [];
let dots: HTMLButtonElement[] = [];
let thumbs: HTMLButtonElement[] = [];
let counterCurrent: Element | null = null;
let counterTotal: Element | null = null;
let nextButton: Element | null = null;
let prevButton: Element | null = null;
let playButton: HTMLButtonElement | null = null;
let activeTitleEl: Element | null = null;
let activeDescriptionEl: Element | null = null;
let totalSlides = 0;

function cleanupProblemStatement() {
  // Stop autoplay
  if (autoplayId !== null) {
    window.clearInterval(autoplayId);
    autoplayId = null;
  }
  isAutoplaying = false;

  // Remove all event listeners
  eventListeners.forEach(({ element, event, handler }) => {
    element.removeEventListener(event, handler);
  });
  eventListeners = [];

  // Reset DOM references
  sliderRoot = null;
  slides = [];
  dots = [];
  thumbs = [];
  counterCurrent = null;
  counterTotal = null;
  nextButton = null;
  prevButton = null;
  playButton = null;
  activeTitleEl = null;
  activeDescriptionEl = null;
  totalSlides = 0;
  currentIndex = 0;
}

function initProblemStatement() {
  // Cleanup existing listeners first
  cleanupProblemStatement();

  // Re-query all DOM elements
  sliderRoot = document.querySelector('[data-ps-slider]');
  slides = sliderRoot
    ? Array.from(sliderRoot.querySelectorAll('.ps-slide'))
    : [];
  dots = Array.from(document.querySelectorAll('[data-ps-dot]'));
  thumbs = Array.from(document.querySelectorAll('[data-ps-thumb]'));
  counterCurrent = document.querySelector('[data-slide-current]');
  counterTotal = document.querySelector('[data-slide-total]');
  nextButton = document.querySelector('[data-ps-next]');
  prevButton = document.querySelector('[data-ps-prev]');
  playButton = document.querySelector('[data-ps-play]');
  activeTitleEl = document.querySelector('[data-active-title]');
  activeDescriptionEl = document.querySelector('[data-active-description]');
  totalSlides = slides.length;

/**
 * @param {boolean} isPlaying
 */
function setPlayButtonState(isPlaying) {
  if (!playButton) return;
  playButton.classList.toggle('is-playing', isPlaying);
  playButton.setAttribute('aria-pressed', isPlaying ? 'true' : 'false');
  playButton.setAttribute('aria-label', isPlaying ? 'Pause autoplay' : 'Start autoplay');
}

/**
 * @param {boolean} [updateState=true]
 */
function stopAutoplay(updateState = true) {
  if (autoplayId !== null) {
    window.clearInterval(autoplayId);
    autoplayId = null;
  }
  if (updateState) {
    isAutoplaying = false;
    setPlayButtonState(false);
  }
}

function startAutoplay() {
  if (!totalSlides || !playButton || playButton.hasAttribute('disabled')) return;
  stopAutoplay(false);
  isAutoplaying = true;
  setPlayButtonState(true);
  autoplayId = window.setInterval(() => {
    updateActiveSlide(currentIndex + 1);
  }, AUTOPLAY_DELAY);
}

function restartAutoplayIfNeeded() {
  if (!isAutoplaying) return;
  startAutoplay();
}

/**
 * @param {number} targetIndex
 */
function updateActiveSlide(targetIndex) {
  if (!totalSlides) return;
  currentIndex = (targetIndex + totalSlides) % totalSlides;
  const activeSlide = slides[currentIndex];

  slides.forEach((slide, idx) => {
    const isActive = idx === currentIndex;
    slide.classList.toggle('is-active', isActive);
    slide.setAttribute('aria-hidden', String(!isActive));
  });

  dots.forEach((dot, idx) => {
    const isActive = idx === currentIndex;
    dot.classList.toggle('is-active', isActive);
    dot.setAttribute('aria-selected', String(isActive));
  });

  thumbs.forEach((thumb, idx) => {
    thumb.classList.toggle('is-active', idx === currentIndex);
  });

  if (counterCurrent) {
    counterCurrent.textContent = (currentIndex + 1).toString().padStart(2, '0');
  }

  if (activeSlide) {
    if (activeTitleEl) {
      activeTitleEl.textContent = activeSlide.dataset.title || '';
    }
    if (activeDescriptionEl) {
      activeDescriptionEl.textContent = activeSlide.dataset.description || '';
    }
  }
}

/**
 * @param {number} targetIndex
 */
function handleManualAdvance(targetIndex) {
  updateActiveSlide(targetIndex);
  restartAutoplayIfNeeded();
}

  if (counterTotal && totalSlides > 0) {
    counterTotal.textContent = totalSlides.toString().padStart(2, '0');
  }

  if (totalSlides) {
    updateActiveSlide(0);

    // Next button
    if (nextButton) {
      const handler = () => handleManualAdvance(currentIndex + 1);
      nextButton.addEventListener('click', handler);
      eventListeners.push({ element: nextButton, event: 'click', handler });
    }

    // Prev button
    if (prevButton) {
      const handler = () => handleManualAdvance(currentIndex - 1);
      prevButton.addEventListener('click', handler);
      eventListeners.push({ element: prevButton, event: 'click', handler });
    }

    // Dots
    dots.forEach((dot) => {
      const handler = () => {
        const index = Number(dot.dataset.index) || 0;
        handleManualAdvance(index);
      };
      dot.addEventListener('click', handler);
      eventListeners.push({ element: dot, event: 'click', handler });
    });

    // Thumbs
    thumbs.forEach((thumb) => {
      const handler = () => {
        const index = Number(thumb.dataset.index) || 0;
        handleManualAdvance(index);
      };
      thumb.addEventListener('click', handler);
      eventListeners.push({ element: thumb, event: 'click', handler });
    });

    // Keyboard navigation
    const keydownHandler = (event: KeyboardEvent) => {
      if (event.key === 'ArrowRight') {
        handleManualAdvance(currentIndex + 1);
      }
      if (event.key === 'ArrowLeft') {
        handleManualAdvance(currentIndex - 1);
      }
    };
    document.addEventListener('keydown', keydownHandler);
    eventListeners.push({ element: document, event: 'keydown', handler: keydownHandler });

    // Play button
    if (playButton) {
      const handler = () => {
        if (!playButton || playButton.hasAttribute('disabled')) return;
        if (isAutoplaying) {
          stopAutoplay();
        } else {
          startAutoplay();
        }
      };
      playButton.addEventListener('click', handler);
      eventListeners.push({ element: playButton, event: 'click', handler });
    }
  }
}

// Initialize on load
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(initProblemStatement, 10);
  });
} else {
  setTimeout(initProblemStatement, 10);
}

// Re-initialize on page navigation
document.addEventListener('astro:page-load', () => {
  setTimeout(initProblemStatement, 50);
});

// Cleanup before page swap
document.addEventListener('astro:before-swap', cleanupProblemStatement);
</script>
