---
import { markdownify } from "@/lib/utils/textConverter";
import type { CollectionEntry } from "astro:content";
import { getEntry } from "astro:content";

const { title, subtitle, cards, cta_text } = (
  (await getEntry(
    "diagnosticLensSection",
    "diagnostic-lens"
  )) as CollectionEntry<"diagnosticLensSection">
).data;

// Icon SVG components
const icons: Record<string, string> = {
  "calendar-check": '<svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>',
  "target": '<svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>',
  "brain": '<svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>',
  "puzzle": '<svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z"></path></svg>',
  "chart-line": '<svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path></svg>',
  "heart": '<svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>',
};
---

<section class="section diagnostic-lens-section">
  <div class="container">
    <div class="row">
      <div class="mx-auto text-center lg:col-10" data-aos="fade-up-sm">
        {title && <h2 class="mb-4" set:html={markdownify(title)} />}
        {
          subtitle && (
            <p
              class="mb-12 text-lg/[inherit]"
              set:html={markdownify(subtitle)}
            />
          )
        }
      </div>
      <div class="col-12" data-aos="fade-up-sm" data-aos-delay="200">
        <div class="service-cards-container">
          {
            cards.map((card, index) => (
              <div 
                class={`service-card service-card-${card.color}`}
              >
                <div class="card-front">
                  <div class="card-icon-wrapper">   
                    <div class="card-icon" set:html={icons[card.icon] || icons["target"]} />
                  </div>
                  <div class="card-labels">
                    <span class="card-label card-label-problem">Problem</span>
                    <span class="card-label card-label-impact">Impact</span>
                  </div>
                  <h3 class="card-title">{card.title}</h3>
                  <p class="card-description">{card.description}</p>
                  <div class="card-hover-hint">
                    <svg class="hint-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                    <span class="hint-text">See solution</span>
                  </div>
                </div>
                <div class="card-solution">
                  <div class="solution-header">Gestalty Solution</div>
                  <p class="solution-text">{card.solution}</p>
                </div>
              </div>
            ))
          }
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  .diagnostic-lens-section {
    padding-top: 4rem;
  }

  @media (min-width: 1024px) {
    .diagnostic-lens-section {
      padding-top: 5rem;
    }
  }

  .service-cards-container {
    display: grid;
    gap: 1.5rem;
  }

  /* Simple 3-column grid for desktop */
  @media (min-width: 1024px) {
    .service-cards-container {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  /* 2-column grid for tablet */
  @media (min-width: 768px) and (max-width: 1023px) {
    .service-cards-container {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  /* Single column for mobile */
  @media (max-width: 767px) {
    .service-cards-container {
      grid-template-columns: 1fr;
    }
  }

  .service-card {
    position: relative;
    padding: 2.5rem 2rem;
    border-radius: 20px 20px 20px 60px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="88" height="34" viewBox="0 0 88 34"><rect x="6" y="5" width="76" height="24" rx="6" fill="%2390ee90" stroke="%23000" stroke-width="2"/><rect x="4" y="3" width="76" height="24" rx="6" fill="%2390ee90" stroke="%23000" stroke-width="2"/><text x="42" y="18.5" font-family="Arial,sans-serif" font-size="11" font-weight="bold" fill="%23000" text-anchor="middle">SOLUTION</text></svg>') 44 17, pointer;
    display: flex;
    flex-direction: column;
    min-height: 280px;
    overflow: hidden;
  }

  .service-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
  }

  .card-front,
  .card-solution {
    transition: opacity 0.4s ease, transform 0.4s ease;
  }

  .card-front {
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .card-solution {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    padding: 2.5rem 2rem;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    opacity: 0;
    pointer-events: none;
    backdrop-filter: blur(10px);
    background: rgba(255, 255, 255, 0.95);
  }

  /* Desktop hover */
  @media (min-width: 1024px) {
    .service-card:hover .card-front {
      opacity: 0;
    }

    .service-card:hover .card-solution {
      opacity: 1;
    }
  }

  /* Mobile click - using active class that will be toggled via JS */
  @media (max-width: 1023px) {
    .service-card.active .card-front {
      opacity: 0;
    }

    .service-card.active .card-solution {
      opacity: 1;
      pointer-events: all;
    }
  }

  /* Solid color backgrounds */
  .service-card-peach {
    background-color: #fff9e6;
  }

  .service-card-blue {
    background-color: #1a2847;
  }

  .service-card-purple {
    background-color: #2d2d2d;
  }

  .service-card-yellow {
    background-color: #ffd54f;
  }

  .service-card-mint {
    background-color: #f5f5f5;
  }

  /* White text for dark backgrounds */
  .service-card-blue .card-title,
  .service-card-purple .card-title,
  .service-card-blue .card-description,
  .service-card-purple .card-description,
  .service-card-blue .hint-text,
  .service-card-purple .hint-text {
    color: #ffffff;
  }

  /* Solution background color adjustments for dark cards */
  .service-card-blue .card-solution,
  .service-card-purple .card-solution {
    background: rgba(26, 40, 71, 0.95);
    color: #ffffff;
  }

  .service-card-peach .card-solution {
    background: rgba(255, 249, 230, 0.95);
  }

  .service-card-yellow .card-solution {
    background: rgba(255, 213, 79, 0.95);
  }

  .service-card-mint .card-solution {
    background: rgba(245, 245, 245, 0.95);
  }

  /* Featured card (hovered) - subtle highlight */
  @media (min-width: 1024px) {
    .service-card:hover {
      z-index: 10;
    }
  }

  .card-icon-wrapper {
    margin-bottom: 1.5rem;
    transition: transform 0.3s ease;
  }

  .card-icon {
    color: currentColor;
    opacity: 0.8;
    transition: transform 0.3s ease, opacity 0.3s ease;
  }

  /* Icon colors - Updated to match theme palette */
  .service-card-peach .card-icon { color: #f59e0b; }
  .service-card-blue .card-icon { color: #ffd54f; }
  .service-card-purple .card-icon { color: #ffd54f; }
  .service-card-yellow .card-icon { color: #1a2847; }
  .service-card-mint .card-icon { color: #2d2d2d; }

  /* Enlarge icon on hover */
  .service-card:hover .card-icon {
    transform: scale(1.15);
    opacity: 1;
  }

  .card-labels {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .card-label {
    padding: 0.375rem 0.875rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .card-label-problem {
    background: rgba(239, 68, 68, 0.15);
    color: #dc2626;
    border: 1px solid rgba(239, 68, 68, 0.3);
  }

  .card-label-impact {
    background: rgba(245, 158, 11, 0.15);
    color: #d97706;
    border: 1px solid rgba(245, 158, 11, 0.3);
  }

  /* Label colors for dark backgrounds */
  .service-card-blue .card-label-problem,
  .service-card-purple .card-label-problem {
    background: rgba(239, 68, 68, 0.25);
    color: #fca5a5;
    border-color: rgba(239, 68, 68, 0.4);
  }

  .service-card-blue .card-label-impact,
  .service-card-purple .card-label-impact {
    background: rgba(245, 158, 11, 0.25);
    color: #fcd34d;
    border-color: rgba(245, 158, 11, 0.4);
  }

  .card-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 1rem;
    color: #1d1d1d;
    line-height: 1.3;
  }

  .card-description {
    font-size: 0.95rem;
    color: #464646;
    line-height: 1.6;
    margin-bottom: auto;
    flex-grow: 1;
  }

  .card-hover-hint {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    font-size: 0.875rem;
    opacity: 0.7;
  }

  .service-card-blue .card-hover-hint,
  .service-card-purple .card-hover-hint {
    border-top-color: rgba(255, 255, 255, 0.2);
  }

  .hint-icon {
    width: 1.25rem;
    height: 1.25rem;
    opacity: 0.8;
  }

  .hint-text {
    font-weight: 500;
    color: #666;
  }

  .solution-header {
    font-size: 1.125rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 1.5rem;
    color: #10b981;
  }

  .service-card-blue .solution-header,
  .service-card-purple .solution-header {
    color: #6ee7b7;
  }

  .solution-text {
    font-size: 1.125rem;
    line-height: 1.7;
    font-weight: 500;
    color: #1d1d1d;
  }

  .service-card-blue .solution-text,
  .service-card-purple .solution-text {
    color: #ffffff;
  }

  /* Mobile responsive adjustments */
  @media (max-width: 1023px) {
    .service-card {
      min-height: 320px;
    }

    .card-title {
      font-size: 1.375rem;
    }

    .card-description {
      font-size: 0.9rem;
    }

    .hint-text::after {
      content: " (tap)";
    }
  }
</style>

<script>
  let eventListeners: Array<{ element: Element | Document; event: string; handler: (e?: any) => void }> = [];
  let cards: NodeListOf<Element> | null = null;

  function cleanupDiagnosticLens() {
    // Remove all event listeners
    eventListeners.forEach(({ element, event, handler }) => {
      element.removeEventListener(event, handler);
    });
    eventListeners = [];
    cards = null;
  }

  function initDiagnosticLens() {
    cleanupDiagnosticLens();

    if (typeof window === 'undefined') return;

    cards = document.querySelectorAll('.service-card');
    
    if (!cards || cards.length === 0) return;

    // Add click handlers for mobile
    cards.forEach(card => {
      const handler = function(this: Element, e: Event) {
        // Only for mobile
        if (window.innerWidth < 1024) {
          // Toggle active class
          const isActive = this.classList.contains('active');
          
          // Remove active from all cards
          cards!.forEach(c => c.classList.remove('active'));
          
          // Toggle current card
          if (!isActive) {
            this.classList.add('active');
          }
        }
      };
      card.addEventListener('click', handler);
      eventListeners.push({ element: card, event: 'click', handler });
    });

    // Close solution when clicking outside
    const outsideClickHandler = (e: Event) => {
      if (window.innerWidth < 1024) {
        const clickedCard = (e.target as Element).closest('.service-card');
        if (!clickedCard && cards) {
          cards.forEach(c => c.classList.remove('active'));
        }
      }
    };
    document.addEventListener('click', outsideClickHandler);
    eventListeners.push({ element: document, event: 'click', handler: outsideClickHandler });
  }

  // Initialize on load
  if (typeof window !== 'undefined') {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(initDiagnosticLens, 10);
      });
    } else {
      setTimeout(initDiagnosticLens, 10);
    }

    // Re-initialize on page navigation
    document.addEventListener('astro:page-load', () => {
      setTimeout(initDiagnosticLens, 50);
    });

    // Cleanup before page swap
    document.addEventListener('astro:before-swap', cleanupDiagnosticLens);
  }
</script>
