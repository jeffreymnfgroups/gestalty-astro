---
import { markdownify } from "@/lib/utils/textConverter";
import type { CollectionEntry } from "astro:content";
import { getEntry } from "astro:content";

const { title, subtitle, cards, cta_text } = (
  (await getEntry(
    "diagnosticLensSection",
    "diagnostic-lens"
  )) as CollectionEntry<"diagnosticLensSection">
).data;

// Icon SVG components
const icons: Record<string, string> = {
  "calendar-check": '<svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>',
  "target": '<svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>',
  "brain": '<svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>',
  "puzzle": '<svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z"></path></svg>',
  "chart-line": '<svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path></svg>',
  "heart": '<svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>',
};

// Highlight solution text patterns (e.g., "Strategic Revision Reminders:", "AI Feedback Loop:")
function highlightSolutionText(text: string): string {
  if (!text) return text;
  
  // Match patterns: One or more capitalized words ending with colon at the start
  // Examples: "Split Syllabus Engine:", "Progress Tracking:", "AI Feedback Loop:", "Strategic Revision Reminders:"
  // Pattern explanation: 
  // ^([A-Z][A-Za-z]+(?:\s+[A-Z][A-Za-z]+)*): - Starts with capital letter word(s), ends with colon
  const pattern = /^([A-Z][A-Za-z]+(?:\s+[A-Z][A-Za-z]+)*):\s*/;
  
  const match = text.match(pattern);
  if (match) {
    const highlighted = match[1]; // The label part without colon
    const rest = text.slice(match[0].length); // Rest of the text
    return `<span class="solution-highlight"><em>${highlighted}:</em></span> ${rest}`;
  }
  
  return text;
}
---
 1
<section class="section diagnostic-lens-section">
  <div class="container">
    <div class="row">
      <div class="mx-auto text-center lg:col-10" data-aos="fade-up-sm">
        {title && <h2 class="mb-4" set:html={markdownify(title)} />}
        {
          subtitle && (
            <p
              class="mb-12 text-lg/[inherit]"
              set:html={markdownify(subtitle)}
            />
          )
        }
      </div>
      <div class="col-12" data-aos="fade-up-sm" data-aos-delay="200">
        <div class="service-cards-container">
          {
            cards.map((card, index) => (
              <div 
                class={`service-card service-card-${card.color}`}
              >
                <div class="card-front">
                  <div class="card-icon-wrapper">   
                    <div class="card-icon" set:html={icons[card.icon] || icons["target"]} />
                  </div>
                  
                  <div class="problem-section">
                    <div class="section-label problem-label">
                      <span class="label-text">Problem:</span>
                    </div>
                    <h3 class="card-title">{card.title}</h3>
                  </div>

                  <div class="impact-section">
                    <div class="section-label impact-label">
                      <span class="label-text">Impact:</span>
                    </div>
                    <p class="card-description">{card.description}</p>
                  </div>

                  <div class="card-hover-hint">
                    <svg class="hint-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                    <span class="hint-text">See solution</span>
                  </div>
                </div>
                <div class="card-solution">
                  <div class="solution-header">
                    <span class="solution-label-text">Gestalty Solution:</span>
                  </div>
                  <p class="solution-text" set:html={highlightSolutionText(card.solution)}></p>
                </div>
              </div>
            ))
          }
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  .diagnostic-lens-section {
    padding-top: 3rem;
    padding-bottom: 3rem;
    overflow-x: hidden;
  }

  .diagnostic-lens-section .container {
    max-width: 100%;
    width: 100%;
    box-sizing: border-box;
    padding-left: 1rem;
    padding-right: 1rem;
  }

  @media (min-width: 1024px) {
    .diagnostic-lens-section {
      padding-top: 4rem;
      padding-bottom: 4rem;
    }

    .diagnostic-lens-section .container {
      padding-left: 1.5rem;
      padding-right: 1.5rem;
    }
  }

  .service-cards-container {
    display: grid;
    gap: 1rem;
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
  }

  /* Simple 3-column grid for desktop */
  @media (min-width: 1024px) {
    .service-cards-container {
      grid-template-columns: repeat(3, 1fr);
      gap: 1.25rem;
    }
  }

  /* 2-column grid for tablet */
  @media (min-width: 768px) and (max-width: 1023px) {
    .service-cards-container {
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }
  }

  /* Single column for mobile */
  @media (max-width: 767px) {
    .service-cards-container {
      grid-template-columns: 1fr;
      gap: 0.875rem;
    }
  }

  .service-card {
    position: relative;
    padding: 1.5rem 1.25rem;
    border-radius: 16px 16px 16px 48px;
    cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="88" height="34" viewBox="0 0 88 34"><rect x="6" y="5" width="76" height="24" rx="6" fill="%2390ee90" stroke="%23000" stroke-width="2"/><rect x="4" y="3" width="76" height="24" rx="6" fill="%2390ee90" stroke="%23000" stroke-width="2"/><text x="42" y="18.5" font-family="Arial,sans-serif" font-size="11" font-weight="bold" fill="%23000" text-anchor="middle">SOLUTION</text></svg>') 44 17, pointer;
    display: flex;
    flex-direction: column;
    min-height: 220px;
    max-height: 100%;
    overflow: hidden;
    will-change: transform;
    z-index: 1;
    transition: z-index 0s;
    box-sizing: border-box;
  }

  .card-front,
  .card-solution {
    will-change: opacity, transform;
  }

  .card-front {
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .card-solution {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    padding: 1.5rem 1.25rem;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    opacity: 0;
    pointer-events: none;
    backdrop-filter: blur(10px);
    background: rgba(255, 255, 255, 0.95);
    box-sizing: border-box;
    overflow-y: auto;
    max-height: 100%;
  }

  /* Desktop hover animations handled by GSAP */

  /* Mobile click - using active class that will be toggled via JS */
  @media (max-width: 1023px) {
    .service-card.active .card-front {
      opacity: 0;
    }

    .service-card.active .card-solution {
      opacity: 1;
      pointer-events: all;
    }
  }

  /* Solid color backgrounds */
  .service-card-peach {
    background-color: #fff9e6;
  }

  .service-card-blue {
    background-color: #1a2847;
  }

  .service-card-purple {
    background-color: #2d2d2d;
  }

  .service-card-yellow {
    background-color: #ffd54f;
  }

  .service-card-mint {
    background-color: #f5f5f5;
  }

  .service-card-brown {
    background-color: #8b6f47;
  }

  /* White text for dark backgrounds */
  .service-card-blue .card-title,
  .service-card-purple .card-title,
  .service-card-brown .card-title,
  .service-card-blue .card-description,
  .service-card-purple .card-description,
  .service-card-brown .card-description,
  .service-card-blue .hint-text,
  .service-card-purple .hint-text,
  .service-card-brown .hint-text {
    color: #ffffff;
  }

  /* Solution background color adjustments - each card keeps its own color */
  .service-card-blue .card-solution {
    background: rgba(26, 40, 71, 0.95);
    color: #ffffff;
  }

  .service-card-purple .card-solution {
    background: rgba(45, 45, 45, 0.95);
    color: #ffffff;
  }

  .service-card-brown .card-solution {
    background: rgba(139, 111, 71, 0.95);
    color: #ffffff;
  }

  .service-card-peach .card-solution {
    background: rgba(255, 249, 230, 0.95);
  }

  .service-card-yellow .card-solution {
    background: rgba(255, 213, 79, 0.95);
  }

  .service-card-mint .card-solution {
    background: rgba(245, 245, 245, 0.95);
  }

  /* Featured card (hovered) - subtle highlight */
  @media (min-width: 1024px) {
    .service-card:hover {
      z-index: 10;
    }
  }

  .card-icon-wrapper {
    margin-bottom: 1rem;
  }

  .card-icon {
    color: currentColor;
    opacity: 0.8;
    will-change: transform, opacity;
  }

  .card-icon svg {
    width: 2.5rem;
    height: 2.5rem;
  }

  /* Icon colors - Updated to match theme palette */
  .service-card-peach .card-icon { color: #f59e0b; }
  .service-card-blue .card-icon { color: #ffd54f; }
  .service-card-purple .card-icon { color: #ffd54f; }
  .service-card-brown .card-icon { color: #ffd54f; }
  .service-card-yellow .card-icon { color: #1a2847; }
  .service-card-mint .card-icon { color: #2d2d2d; }

  /* Icon animation handled by GSAP */

  /* Problem and Impact Sections */
  .problem-section {
    margin-bottom: 1.5rem;
  }

  .impact-section {
    margin-bottom: 1.5rem;
  }

  .section-label {
    margin-bottom: 0.75rem;
  }

  .label-text {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-block;
    padding-bottom: 0.4rem;
    position: relative;
  }

  .problem-label .label-text {
    color: #dc2626;
    border-bottom: 2px solid #dc2626;
  }

  .impact-label .label-text {
    color: #d97706;
    border-bottom: 2px solid #d97706;
  }

  /* Label styles for dark backgrounds */
  .service-card-blue .problem-label .label-text,
  .service-card-purple .problem-label .label-text,
  .service-card-brown .problem-label .label-text {
    color: #fca5a5;
    border-bottom-color: #fca5a5;
  }

  .service-card-blue .impact-label .label-text,
  .service-card-purple .impact-label .label-text,
  .service-card-brown .impact-label .label-text {
    color: #fcd34d;
    border-bottom-color: #fcd34d;
  }

  .card-title {
    font-size: 1.125rem;
    font-weight: 700;
    margin: 0;
    color: #1d1d1d;
    line-height: 1.35;
  }

  .card-description {
    font-size: 0.875rem;
    color: #464646;
    line-height: 1.6;
    margin: 0;
  }

  .card-hover-hint {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: auto;
    padding-top: 1rem;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    font-size: 0.75rem;
    opacity: 0.7;
  }

  .service-card-blue .card-hover-hint,
  .service-card-purple .card-hover-hint,
  .service-card-brown .card-hover-hint {
    border-top-color: rgba(255, 255, 255, 0.2);
  }

  .hint-icon {
    width: 1.25rem;
    height: 1.25rem;
    opacity: 0.8;
  }

  .hint-text {
    font-weight: 500;
    color: #666;
  }

  .solution-header {
    margin-bottom: 1rem;
  }

  .solution-label-text {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-block;
    padding-bottom: 0.4rem;
    color: #10b981;
    border-bottom: 2px solid #10b981;
  }

  .service-card-blue .solution-label-text,
  .service-card-purple .solution-label-text,
  .service-card-brown .solution-label-text {
    color: #6ee7b7;
    border-bottom-color: #6ee7b7;
  }

  .solution-text {
    font-size: 0.9375rem;
    line-height: 1.8;
    font-weight: 500;
    color: #1d1d1d;
  }

  .solution-highlight {
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #fbbf24 100%);
    background-size: 200% 100%;
    padding: 0.25rem 0.625rem;
    border-radius: 6px;
    font-weight: 700;
    font-style: italic;
    color: #1a1a1a;
    display: inline-block;
    box-shadow: 
      0 2px 8px rgba(251, 191, 36, 0.3),
      0 4px 12px rgba(245, 158, 11, 0.2),
      inset 0 1px 0 rgba(255, 255, 255, 0.4);
    border: 1.5px solid rgba(245, 158, 11, 0.4);
    text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
    letter-spacing: 0.3px;
    margin-right: 0.375rem;
    position: relative;
    animation: shimmer 3s ease-in-out infinite;
  }

  @keyframes shimmer {
    0%, 100% {
      background-position: 0% 0%;
    }
    50% {
      background-position: 100% 0%;
    }
  }

  .solution-highlight em,
  .solution-highlight strong {
    font-weight: 700;
    font-style: italic;
    display: inline-block;
  }

  .service-card-blue .solution-highlight,
  .service-card-purple .solution-highlight,
  .service-card-brown .solution-highlight {
    background: linear-gradient(135deg, #10b981 0%, #059669 50%, #10b981 100%);
    background-size: 200% 100%;
    color: #ffffff;
    box-shadow: 
      0 2px 8px rgba(16, 185, 129, 0.4),
      0 4px 12px rgba(5, 150, 105, 0.3),
      inset 0 1px 0 rgba(255, 255, 255, 0.2);
    border: 1.5px solid rgba(16, 185, 129, 0.5);
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
  }

  .service-card-peach .solution-highlight {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 50%, #f59e0b 100%);
    background-size: 200% 100%;
    box-shadow: 
      0 2px 8px rgba(245, 158, 11, 0.4),
      0 4px 12px rgba(217, 119, 6, 0.3),
      inset 0 1px 0 rgba(255, 255, 255, 0.3);
  }

  .service-card-yellow .solution-highlight {
    background: linear-gradient(135deg, #1a2847 0%, #0f172a 50%, #1a2847 100%);
    background-size: 200% 100%;
    color: #ffd54f;
    box-shadow: 
      0 2px 8px rgba(26, 40, 71, 0.5),
      0 4px 12px rgba(15, 23, 42, 0.4),
      inset 0 1px 0 rgba(255, 213, 79, 0.2);
    border: 1.5px solid rgba(255, 213, 79, 0.4);
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
  }

  .service-card-mint .solution-highlight {
    background: linear-gradient(135deg, #10b981 0%, #059669 50%, #10b981 100%);
    background-size: 200% 100%;
    color: #ffffff;
    box-shadow: 
      0 2px 8px rgba(16, 185, 129, 0.4),
      0 4px 12px rgba(5, 150, 105, 0.3),
      inset 0 1px 0 rgba(255, 255, 255, 0.2);
    border: 1.5px solid rgba(16, 185, 129, 0.5);
  }

  .service-card-blue .solution-text,
  .service-card-purple .solution-text,
  .service-card-brown .solution-text {
    color: #ffffff;
  }

  /* Mobile responsive adjustments */
  @media (max-width: 1023px) {
    .service-card {
      min-height: 240px;
      padding: 1.25rem 1rem;
    }

    .card-solution {
      padding: 1.25rem 1rem;
    }

    .card-title {
      font-size: 1.0625rem;
    }

    .card-description {
      font-size: 0.8125rem;
    }

    .solution-text {
      font-size: 0.875rem;
      line-height: 1.7;
    }

    .solution-highlight {
      padding: 0.2rem 0.5rem;
      font-size: 0.875rem;
      border-radius: 5px;
      box-shadow: 
        0 1px 6px rgba(251, 191, 36, 0.3),
        0 2px 8px rgba(245, 158, 11, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }

    .service-card-blue .solution-highlight,
    .service-card-purple .solution-highlight,
    .service-card-brown .solution-highlight {
      box-shadow: 
        0 1px 6px rgba(16, 185, 129, 0.4),
        0 2px 8px rgba(5, 150, 105, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    .problem-section {
      margin-bottom: 0.875rem;
    }

    .impact-section {
      margin-bottom: 0.875rem;
    }

    .card-icon-wrapper {
      margin-bottom: 0.875rem;
    }

    .card-icon svg {
      width: 2rem;
      height: 2rem;
    }

    .hint-text::after {
      content: " (tap)";
    }
  }
</style>

<script>
  import { gsap } from 'gsap';

  let eventListeners: Array<{ element: Element | Document; event: string; handler: (e?: any) => void }> = [];
  let cards: NodeListOf<Element> | null = null;
  let gsapAnimations: Map<Element, gsap.core.Timeline> = new Map();
  let currentlyHoveredCard: Element | null = null;
  let cardAnimations: Map<Element, { hoverTimeline: gsap.core.Timeline | null; cardTween: gsap.core.Tween | null; iconTween: gsap.core.Tween | null }> = new Map();

  function resetCardToDefault(card: Element, immediate = false) {
    const cardFront = card.querySelector('.card-front') as HTMLElement;
    const cardSolution = card.querySelector('.card-solution') as HTMLElement;
    const cardIcon = card.querySelector('.card-icon') as HTMLElement;
    const cardEl = card as HTMLElement;

    if (!cardFront || !cardSolution) return;

    // Kill all animations for this card
    const animData = cardAnimations.get(card);
    if (animData) {
      if (animData.hoverTimeline) {
        animData.hoverTimeline.kill();
        animData.hoverTimeline = null;
      }
      if (animData.cardTween) {
        animData.cardTween.kill();
        animData.cardTween = null;
      }
      if (animData.iconTween) {
        animData.iconTween.kill();
        animData.iconTween = null;
      }
    }

    gsap.killTweensOf([card, cardFront, cardSolution, cardIcon]);

    if (immediate) {
      // Immediate reset - no animation
      gsap.set(card, { y: 0, boxShadow: '0 0 0 rgba(0, 0, 0, 0)', zIndex: 1 });
      gsap.set(cardFront, { opacity: 1, transform: 'translateY(0) scale(1)' });
      gsap.set(cardSolution, { opacity: 0, transform: 'translateY(10px) scale(0.98)', pointerEvents: 'none' });
      gsap.set(cardIcon, { scale: 1, opacity: 0.8 });
    } else {
      // Animated reset
      gsap.to(card, {
        duration: 0.3,
        y: 0,
        boxShadow: '0 0 0 rgba(0, 0, 0, 0)',
        zIndex: 1,
        ease: 'power2.out',
        overwrite: true
      });

      gsap.to(cardIcon, {
        duration: 0.3,
        scale: 1,
        opacity: 0.8,
        ease: 'power2.out',
        overwrite: true
      });

      gsap.to(cardFront, {
        duration: 0.3,
        opacity: 1,
        scale: 1,
        y: 0,
        ease: 'power2.out',
        overwrite: true
      });

      gsap.to(cardSolution, {
        duration: 0.3,
        opacity: 0,
        scale: 0.98,
        y: 10,
        pointerEvents: 'none',
        ease: 'power2.in',
        overwrite: true
      });
    }

    gsapAnimations.delete(card);
  }

  function cleanupDiagnosticLens() {
    // Kill all GSAP animations
    gsapAnimations.forEach((tl) => {
      if (tl) tl.kill();
    });
    gsapAnimations.clear();

    // Kill all card-specific animations
    cardAnimations.forEach((animData) => {
      if (animData.hoverTimeline) animData.hoverTimeline.kill();
      if (animData.cardTween) animData.cardTween.kill();
      if (animData.iconTween) animData.iconTween.kill();
    });
    cardAnimations.clear();

    // Kill any lingering animations on cards
    if (cards) {
      cards.forEach((card) => {
        gsap.killTweensOf(card);
        const cardFront = card.querySelector('.card-front');
        const cardSolution = card.querySelector('.card-solution');
        const cardIcon = card.querySelector('.card-icon');
        if (cardFront) gsap.killTweensOf(cardFront);
        if (cardSolution) gsap.killTweensOf(cardSolution);
        if (cardIcon) gsap.killTweensOf(cardIcon);
      });
    }

    // Remove all event listeners
    eventListeners.forEach(({ element, event, handler }) => {
      element.removeEventListener(event, handler);
    });
    eventListeners = [];
    cards = null;
    currentlyHoveredCard = null;
  }

  function initDiagnosticLens() {
    cleanupDiagnosticLens();

    if (typeof window === 'undefined') return;

    cards = document.querySelectorAll('.service-card');
    
    if (!cards || cards.length === 0) return;

    const isDesktop = window.innerWidth >= 1024;

    cards.forEach((card) => {
      const cardFront = card.querySelector('.card-front') as HTMLElement;
      const cardSolution = card.querySelector('.card-solution') as HTMLElement;
      const cardIcon = card.querySelector('.card-icon') as HTMLElement;

      if (!cardFront || !cardSolution) return;

      // Set initial states
      gsap.set(card, { zIndex: 1 });
      gsap.set(cardFront, { opacity: 1, transform: 'translateY(0) scale(1)' });
      gsap.set(cardSolution, { opacity: 0, transform: 'translateY(10px) scale(0.98)', pointerEvents: 'none' });
      gsap.set(cardIcon, { scale: 1, opacity: 0.8 });

      if (isDesktop) {
        // Desktop: Hover animations with GSAP
        // Initialize animation data for this card
        cardAnimations.set(card, {
          hoverTimeline: null,
          cardTween: null,
          iconTween: null
        });
        
        const mouseEnterHandler = () => {
          // Immediately set this card's z-index high to prevent overlap
          gsap.set(card, { zIndex: 10 });

          // Reset all other cards immediately to prevent overlap
          if (currentlyHoveredCard && currentlyHoveredCard !== card) {
            resetCardToDefault(currentlyHoveredCard, true);
          }

          // Reset all cards except the current one
          if (cards) {
            cards.forEach((c) => {
              if (c !== card && c !== currentlyHoveredCard) {
                resetCardToDefault(c, true);
              }
            });
          }

          // Update currently hovered card
          currentlyHoveredCard = card;

          // Get animation data for this card
          const animData = cardAnimations.get(card);
          if (!animData) return;

          // Kill any existing animations first to prevent conflicts
          if (animData.hoverTimeline) {
            animData.hoverTimeline.kill();
          }
          if (animData.cardTween) {
            animData.cardTween.kill();
          }
          if (animData.iconTween) {
            animData.iconTween.kill();
          }

          // Kill all tweens on this card
          gsap.killTweensOf([card, cardFront, cardSolution, cardIcon]);

          // Reset all states first
          gsap.set(cardFront, { opacity: 1, transform: 'translateY(0) scale(1)' });
          gsap.set(cardSolution, { opacity: 0, transform: 'translateY(10px) scale(0.98)', pointerEvents: 'none' });
          gsap.set(cardIcon, { scale: 1, opacity: 0.8 });

          // Create fresh timeline
          animData.hoverTimeline = gsap.timeline();
          
          // Card lift animation
          animData.cardTween = gsap.to(card, {
            duration: 0.4,
            y: -4,
            boxShadow: '0 10px 30px rgba(0, 0, 0, 0.15)',
            ease: 'power2.out',
            overwrite: true
          });

          // Icon animation
          animData.iconTween = gsap.to(cardIcon, {
            duration: 0.3,
            scale: 1.15,
            opacity: 1,
            ease: 'back.out(1.7)',
            overwrite: true
          });

          // Card flip animation
          animData.hoverTimeline
            .to(cardFront, {
              duration: 0.4,
              opacity: 0,
              scale: 0.95,
              y: -10,
              ease: 'power2.in'
            }, 0)
            .to(cardSolution, {
              duration: 0.4,
              opacity: 1,
              scale: 1,
              y: 0,
              pointerEvents: 'all',
              ease: 'power2.out'
            }, 0.1);

          gsapAnimations.set(card, animData.hoverTimeline);
        };

        const mouseLeaveHandler = () => {
          // Only reset if this is the currently hovered card
          if (currentlyHoveredCard === card) {
            currentlyHoveredCard = null;
          }

          // Reset this card
          resetCardToDefault(card, false);
        };

        card.addEventListener('mouseenter', mouseEnterHandler);
        card.addEventListener('mouseleave', mouseLeaveHandler);

        eventListeners.push(
          { element: card, event: 'mouseenter', handler: mouseEnterHandler },
          { element: card, event: 'mouseleave', handler: mouseLeaveHandler }
        );
      } else {
        // Mobile: Click animations with GSAP
        const clickHandler = function(this: Element) {
          const isActive = this.classList.contains('active');
          
          // Remove active from all cards with animation
          cards!.forEach((c) => {
            if (c !== this && c.classList.contains('active')) {
              const front = c.querySelector('.card-front') as HTMLElement;
              const solution = c.querySelector('.card-solution') as HTMLElement;
              if (front && solution) {
                gsap.to(front, {
                  duration: 0.3,
                  opacity: 1,
                  scale: 1,
                  y: 0,
                  ease: 'power2.out'
                });
                gsap.to(solution, {
                  duration: 0.3,
                  opacity: 0,
                  scale: 0.98,
                  y: 10,
                  ease: 'power2.in'
                });
              }
              c.classList.remove('active');
            }
          });
          
          // Toggle current card
          if (!isActive) {
            this.classList.add('active');
            gsap.to(cardFront, {
              duration: 0.3,
              opacity: 0,
              scale: 0.95,
              y: -10,
              ease: 'power2.in'
            });
            gsap.to(cardSolution, {
              duration: 0.3,
              opacity: 1,
              scale: 1,
              y: 0,
              ease: 'power2.out',
              delay: 0.1
            });
          } else {
            gsap.to(cardFront, {
              duration: 0.3,
              opacity: 1,
              scale: 1,
              y: 0,
              ease: 'power2.out'
            });
            gsap.to(cardSolution, {
              duration: 0.3,
              opacity: 0,
              scale: 0.98,
              y: 10,
              ease: 'power2.in'
            });
          }
        };

        card.addEventListener('click', clickHandler);
        eventListeners.push({ element: card, event: 'click', handler: clickHandler });
      }
    });

    // Close solution when clicking outside (mobile only)
    if (!isDesktop) {
      const outsideClickHandler = (e: Event) => {
        const clickedCard = (e.target as Element).closest('.service-card');
        if (!clickedCard && cards) {
          cards.forEach((c) => {
            if (c.classList.contains('active')) {
              const front = c.querySelector('.card-front') as HTMLElement;
              const solution = c.querySelector('.card-solution') as HTMLElement;
              if (front && solution) {
                gsap.to(front, {
                  duration: 0.3,
                  opacity: 1,
                  scale: 1,
                  y: 0,
                  ease: 'power2.out'
                });
                gsap.to(solution, {
                  duration: 0.3,
                  opacity: 0,
                  scale: 0.98,
                  y: 10,
                  ease: 'power2.in'
                });
              }
              c.classList.remove('active');
            }
          });
        }
      };
      document.addEventListener('click', outsideClickHandler);
      eventListeners.push({ element: document, event: 'click', handler: outsideClickHandler });
    }
  }

  // Initialize on load
  if (typeof window !== 'undefined') {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(initDiagnosticLens, 10);
      });
    } else {
      setTimeout(initDiagnosticLens, 10);
    }

    // Re-initialize on page navigation
    document.addEventListener('astro:page-load', () => {
      setTimeout(initDiagnosticLens, 50);
    });

    // Cleanup before page swap
    document.addEventListener('astro:before-swap', cleanupDiagnosticLens);

    // Handle window resize
    let resizeTimeout: number;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = window.setTimeout(() => {
        initDiagnosticLens();
      }, 250);
    });
  }
</script>
