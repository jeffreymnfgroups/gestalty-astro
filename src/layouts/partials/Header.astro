---
import ImageMod from "@/components/ImageMod.astro";
import Logo from "@/components/Logo.astro";
import config from "@/config/config.json";
import menu from "@/config/menu.json";
import DynamicIcon from "@/helpers/DynamicIcon";
import HomeBanner from "./HomeBanner.astro";

export interface ChildNavigationLink {
  name: string;
  url: string;
}

export interface NavigationLink {
  name: string;
  url: string;
  hasChildren?: boolean;
  children?: ChildNavigationLink[];
}

const { banner, errorPage } = Astro.props;

const { main }: { main: NavigationLink[] } = menu;
const { login_button, navigation_button } = config;
const { pathname } = Astro.url;
---

<div
  class={`header-wrapper ${Astro.url.pathname === "/" ? "relative" : !errorPage && "pb-4"}`}>
  <!-- Scroll Progress Indicator -->
  <div 
    id="scroll-progress-bar" 
    class="fixed top-0 left-0 right-0 h-[3px] bg-[#fbc10d] z-[60] transition-all duration-100"
    style="width: 0%;">
  </div>
  
  <header 
    id="main-header"
    class={`header-modern fixed top-0 left-0 right-0 z-50 w-full transition-all duration-300 ${banner ? 'header-home' : ''}`}>
    <div class="w-full max-w-[75rem] mx-auto px-4 sm:px-6 py-1.5">
      <nav
        class="navbar-modern flex items-center justify-between transition-all duration-300 rounded-full shadow-sm bg-body/95 backdrop-blur-md px-3 py-1.5"
        id="header-nav">
        <!-- Logo -->
        <div class="flex items-center">
          <Logo />
        </div>
        
        <!-- Desktop Navigation Menu - visible from 1024px (lg) and above -->
        <div class="hidden lg:flex bg-primary/5 rounded-3xl py-1.5 px-1">
          <ul class="flex gap-0 2xl:gap-1">
            {
              main.map((item) => (
                <li>
                  <a
                    href={item.url}
                    class={`nav-link-modern px-3 py-1.5 font-medium font-primary text-sm transition-all duration-200 whitespace-nowrap ${
                      pathname === item.url || pathname === `${item.url}/`
                        ? "nav-link-active"
                        : "text-text/60 hover:text-text-dark hover:bg-body hover:rounded-3xl hover:shadow-sm"
                    }`}>
                    {item.name}
                  </a>
                </li>
              ))
            }
          </ul>
        </div>
        
        <div class="flex items-center gap-2 xl:gap-4">
          <!-- Login Button - visible from 1024px (lg) and above -->
          {
            login_button.enable && (
              <a
                class="btn btn-dark hidden lg:flex px-4 py-1 text-xs shadow-lg login-button"
                href={login_button.link}>
                {login_button.label}
                <span class="icon-wrapper">
                  <span class="icon">
                    <DynamicIcon icon={"FaArrowRight"} />
                  </span>
                  <span class="icon" aria-hidden="true">
                    <DynamicIcon icon={"FaArrowRight"} />
                  </span>
                </span>
              </a>
            )
          }
          
          <!-- CTA Button - visible from 1024px (lg) and above -->
          {
            navigation_button.enable && (
              <a
                class="btn btn-dark hidden lg:flex px-4 py-1 text-xs shadow-lg navigation-button"
                href={navigation_button.link}>
                {navigation_button.label}
                <span class="icon-wrapper">
                  <span class="icon">
                    <DynamicIcon icon={"FaArrowRight"} />
                  </span>
                  <span class="icon" aria-hidden="true">
                    <DynamicIcon icon={"FaArrowRight"} />
                  </span>
                </span>
              </a>
            )
          }
          
          <!-- Burger Menu - only visible below 1024px -->
          <button
            id="mobile-menu-toggle"
            class="flex lg:hidden items-center justify-center w-10 h-10 text-text-dark hover:text-secondary transition-colors duration-200 -mr-2"
            aria-label="Toggle mobile menu">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="flex-shrink-0">
              <path d="M4.5 12h15M4.5 6.23h15M4.5 17.77h15"></path>
            </svg>
          </button>
        </div>
      </nav>
      
      <!-- Mobile sidebar backdrop -->
      <div
        id="mobile-backdrop"
        class="hidden fixed top-0 left-0 w-full h-full bg-black/50 z-40">
      </div>
      
      <!-- Mobile sidebar - only visible below 1024px -->
      <div
        id="mobile-sidebar"
        class="lg:hidden fixed top-0 right-0 h-full bg-body shadow-xl transform transition-transform duration-300 ease-in-out w-full max-w-xs translate-x-full z-50 flex flex-col">
        <!-- Mobile Menu Header -->
        <div class="flex items-center justify-between px-4 py-4 border-b border-border flex-shrink-0">
          <h2 class="text-lg font-bold font-secondary text-text-dark">Menu</h2>
          <button
            id="mobile-menu-close"
            aria-label="Close mobile menu"
            class="flex items-center justify-center w-10 h-10 p-2 hover:bg-light rounded-full transition-colors duration-200">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2.5"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="text-text-dark">
              <path d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        
        <!-- Mobile Menu Content -->
        <div class="flex-1 overflow-y-auto px-4 py-4">
          <ul class="flex flex-col gap-0">
            {
              main.map((item) => (
                <li class="w-full">
                  <a
                    href={item.url}
                    class="nav-link-mobile block text-text-dark hover:text-secondary hover:bg-light rounded-md text-base font-medium font-primary transition-colors duration-200 w-full p-3 px-4">
                    {item.name}
                  </a>
                </li>
              ))
            }
          </ul>
          <div class="flex flex-col items-center gap-3 px-2 mt-6 pb-4">
            <!-- Mobile Login Button -->
            {
              login_button.enable && (
                <a
                  class="btn btn-dark w-full justify-center px-4 py-3 text-base shadow-lg login-button"
                  href={login_button.link}>
                  {login_button.label}
                  <span class="icon-wrapper">
                    <span class="icon">
                      <DynamicIcon icon={"FaArrowRight"} />
                    </span>
                    <span class="icon" aria-hidden="true">
                      <DynamicIcon icon={"FaArrowRight"} />
                    </span>
                  </span>
                </a>
              )
            }
            
            {
              navigation_button.enable && (
                <a
                  class="btn btn-dark w-full justify-center px-4 py-3 text-base shadow-lg navigation-button"
                  href={navigation_button.link}>
                  {navigation_button.label}
                  <span class="icon-wrapper">
                    <span class="icon">
                      <DynamicIcon icon={"FaArrowRight"} />
                    </span>
                    <span class="icon" aria-hidden="true">
                      <DynamicIcon icon={"FaArrowRight"} />
                    </span>
                  </span>
                </a>
              )
            }
          </div>
        </div>
      </div>
    </div>
  </header>

  {/* Show Only In Home Page */}
  {banner && <HomeBanner />}

  <div aria-hidden="true">
    <ImageMod
      class="pointer-events-none absolute top-0 -z-10 h-full w-full object-cover object-top"
      src={Astro.url.pathname === "/"
        ? "/images/banner-bg.png"
        : "/images/page-header.png"}
      alt="header image"
      format="webp"
    />
  </div>
</div>

<style>
  .login-button {
    background-color: #fbc10d !important;
    border-color: #fbc10d !important;
    min-width: 120px;
  }
  
  .login-button:hover {
    background-color: #19254c !important;
    border-color: #19254c !important;
  }
  
  .navigation-button {
    background-color: #19254c !important;
    border-color: #19254c !important;
    min-width: 120px;
  }
  
  .navigation-button:hover {
    background-color: #fbc10d !important;
    border-color: #fbc10d !important;
  }
  
  .header-modern.header-hidden {
    transform: translateY(-100%);
    opacity: 0;
    pointer-events: none;
  }
</style>

<script>
  // Store references for cleanup
  let scrollHandler: (() => void) | null = null;
  let throttledScrollHandler: (() => void) | null = null;
  let scrollListenersAttached = false;
  let menuEventListeners: Array<{ element: Element; event: string; handler: () => void }> = [];
  let rafId: number | null = null;

  // Throttle utility using requestAnimationFrame
  function throttleRAF(func: () => void): () => void {
    return () => {
      if (rafId === null) {
        rafId = requestAnimationFrame(() => {
          func();
          rafId = null;
        });
      }
    };
  }

  function initHeader() {
    // Get DOM elements (re-query on each init)
    const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
    const mobileMenuClose = document.getElementById('mobile-menu-close');
    const mobileSidebar = document.getElementById('mobile-sidebar');
    const mobileBackdrop = document.getElementById('mobile-backdrop');
    const mainHeader = document.getElementById('main-header');
    const progressBar = document.getElementById('scroll-progress-bar');

    // Cleanup existing menu event listeners
    menuEventListeners.forEach(({ element, event, handler }) => {
      element.removeEventListener(event, handler);
    });
    menuEventListeners = [];

    function openMobileMenu() {
      mobileSidebar?.classList.remove('translate-x-full');
      mobileBackdrop?.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeMobileMenu() {
      mobileSidebar?.classList.add('translate-x-full');
      mobileBackdrop?.classList.add('hidden');
      document.body.style.overflow = '';
    }

    // Attach menu event listeners
    if (mobileMenuToggle) {
      menuEventListeners.push({ element: mobileMenuToggle, event: 'click', handler: openMobileMenu });
      mobileMenuToggle.addEventListener('click', openMobileMenu);
    }
    
    if (mobileMenuClose) {
      menuEventListeners.push({ element: mobileMenuClose, event: 'click', handler: closeMobileMenu });
      mobileMenuClose.addEventListener('click', closeMobileMenu);
    }
    
    if (mobileBackdrop) {
      menuEventListeners.push({ element: mobileBackdrop, event: 'click', handler: closeMobileMenu });
      mobileBackdrop.addEventListener('click', closeMobileMenu);
    }

    // Scroll progress and header visibility handler
    scrollHandler = () => {
      const currentScrollY = window.scrollY;
      
      // Update scroll progress bar
      if (progressBar) {
        const scrollHeight = document.documentElement.scrollHeight - window.innerHeight;
        const scrollPercent = scrollHeight > 0 ? (currentScrollY / scrollHeight) * 100 : 0;
        progressBar.style.width = `${Math.min(100, Math.max(0, scrollPercent))}%`;
      }
      
      // Hide header when past hero section (works on all pages)
      if (mainHeader) {
        const heroSection = document.getElementById('hero-section') || 
                           document.querySelector('[data-hero-section]');
        
        if (heroSection) {
          const heroBottom = heroSection.offsetTop + heroSection.offsetHeight;
          const shouldHide = currentScrollY > heroBottom;
          
          if (shouldHide) {
            mainHeader.classList.add('header-hidden');
          } else {
            mainHeader.classList.remove('header-hidden');
          }
        } else {
          // No hero section found, show header
          mainHeader.classList.remove('header-hidden');
        }
      }
    };

    // Create throttled scroll handler
    throttledScrollHandler = throttleRAF(scrollHandler);

    // Remove existing scroll listener if any
    if (scrollListenersAttached) {
      window.removeEventListener('scroll', throttledScrollHandler!, { passive: true } as EventListenerOptions);
    }

    // Attach throttled scroll listener
    window.addEventListener('scroll', throttledScrollHandler, { passive: true });
    scrollListenersAttached = true;
    
    // Initialize on load
    scrollHandler();

    // Close mobile menu on navigation
    closeMobileMenu();
  }

  function cleanupHeader() {
    // Remove scroll listener
    if (throttledScrollHandler && scrollListenersAttached) {
      window.removeEventListener('scroll', throttledScrollHandler, { passive: true } as EventListenerOptions);
      scrollListenersAttached = false;
    }

    // Cleanup menu event listeners
    menuEventListeners.forEach(({ element, event, handler }) => {
      element.removeEventListener(event, handler);
    });
    menuEventListeners = [];

    // Cancel pending animation frame
    if (rafId !== null) {
      cancelAnimationFrame(rafId);
      rafId = null;
    }

    scrollHandler = null;
    throttledScrollHandler = null;
  }

  // Initialize on load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initHeader);
  } else {
    initHeader();
  }

  // Re-initialize on page navigation (Astro transitions)
  document.addEventListener('astro:page-load', () => {
    cleanupHeader();
    // Small delay to ensure DOM is ready
    setTimeout(initHeader, 10);
  });

  // Cleanup before page swap
  document.addEventListener('astro:before-swap', cleanupHeader);
</script>
